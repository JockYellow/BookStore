

===== app.py =====
import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import datetime, timedelta
import json
from pathlib import Path
from typing import Dict, List, Optional

# è¨­ç½®é é¢é…ç½®
st.set_page_config(
    page_title="æ›¸æˆ¿è¨˜å¸³èˆ‡ç‡Ÿé‹ç®¡ç†ç³»çµ±",
    page_icon="ğŸ“š",
    layout="wide",
    initial_sidebar_state="expanded"
)

# åˆå§‹åŒ– session state
if 'current_page' not in st.session_state:
    st.session_state.current_page = 'dashboard'

# æ•¸æ“šæ–‡ä»¶å¤¾
DATA_DIR = Path("data")
DATA_DIR.mkdir(exist_ok=True)

# åŠ è¼‰æ•¸æ“š
def load_data(collection_name: str) -> Dict:
    file_path = DATA_DIR / f"{collection_name}.json"
    if file_path.exists():
        with open(file_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}

# ä¿å­˜æ•¸æ“š
def save_data(collection_name: str, data: Dict):
    file_path = DATA_DIR / f"{collection_name}.json"
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# å´é‚Šæ¬„ - å°èˆª
with st.sidebar:
    st.title("ğŸ“š æ›¸æˆ¿ç®¡ç†ç³»çµ±")
    st.write("---")
    
    menu = ["å„€è¡¨æ¿", "å•†å“ç®¡ç†", "é€²è²¨ç®¡ç†", "éŠ·å”®ç®¡ç†", "æœƒå“¡ç®¡ç†", "ä¾›æ‡‰å•†ç®¡ç†", "å ±è¡¨åˆ†æ"]
    for i, item in enumerate(menu):
        if st.button(item, key=f"menu_{i}", use_container_width=True):
            st.session_state.current_page = item
    
    st.write("---")
    st.caption(f"ç‰ˆæœ¬: 1.0.0")

# å„€è¡¨æ¿é é¢
if st.session_state.current_page == "å„€è¡¨æ¿":
    st.title("ğŸ“Š å„€è¡¨æ¿")
    
    # ç²å–éŠ·å”®æ•¸æ“š
    sales = load_data("sales")
    products = load_data("products")
    
    # è¨ˆç®—ä»Šæ—¥éŠ·å”®é¡
    today = datetime.now().strftime("%Y-%m-%d")
    today_sales = [s for s in sales.values() if s.get('sale_date', '').startswith(today)]
    
    # è¨ˆç®—æŒ‡æ¨™
    total_sales_today = sum(s.get('final_amount', 0) for s in today_sales)
    total_orders_today = len(today_sales)
    
    # é¡¯ç¤º KPI å¡ç‰‡
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("ä»Šæ—¥éŠ·å”®é¡", f"${total_sales_today:,.0f}")
    with col2:
        st.metric("ä»Šæ—¥è¨‚å–®æ•¸", total_orders_today)
    with col3:
        avg_order = total_sales_today / total_orders_today if total_orders_today > 0 else 0
        st.metric("å¹³å‡è¨‚å–®åƒ¹å€¼", f"${avg_order:,.0f}" if avg_order > 0 else "$0")
    
    st.write("---")
    
    # éŠ·å”®è¶¨å‹¢åœ–
    st.subheader("éŠ·å”®è¶¨å‹¢")
    
    # ç²å–æœ€è¿‘30å¤©çš„éŠ·å”®æ•¸æ“š
    date_range = pd.date_range(end=datetime.now(), periods=30).date
    sales_by_date = {}
    
    for date in date_range:
        date_str = date.strftime("%Y-%m-%d")
        daily_sales = [s for s in sales.values() if s.get('sale_date', '').startswith(date_str)]
        sales_by_date[date_str] = sum(s.get('final_amount', 0) for s in daily_sales)
    
    # å‰µå»ºæŠ˜ç·šåœ–
    df_sales = pd.DataFrame({
        'æ—¥æœŸ': list(sales_by_date.keys()),
        'éŠ·å”®é¡': list(sales_by_date.values())
    })
    
    fig = px.line(df_sales, x='æ—¥æœŸ', y='éŠ·å”®é¡', title='æœ€è¿‘30å¤©éŠ·å”®è¶¨å‹¢')
    st.plotly_chart(fig, use_container_width=True)
    
    # ä½åº«å­˜å•†å“æé†’
    st.subheader("ä½åº«å­˜æé†’")
    low_stock_products = [p for p in products.values() if p.get('stock', 0) < 5]
    
    if low_stock_products:
        for product in low_stock_products:
            st.warning(f"{product.get('name')} åº«å­˜ä¸è¶³: {product.get('stock', 0)} ä»¶")
    else:
        st.success("ç›®å‰æ²’æœ‰ä½åº«å­˜å•†å“")
    
    # æœ€è¿‘äº¤æ˜“è¨˜éŒ„
    st.subheader("æœ€è¿‘äº¤æ˜“")
    recent_sales = sorted(sales.values(), key=lambda x: x.get('sale_date', ''), reverse=True)[:5]
    
    if recent_sales:
        for sale in recent_sales:
            st.write(f"**{sale.get('sale_date', '')}** - ${sale.get('final_amount', 0):,.0f}")
    else:
        st.info("æš«ç„¡äº¤æ˜“è¨˜éŒ„")

# å•†å“ç®¡ç†é é¢
elif st.session_state.current_page == "å•†å“ç®¡ç†":
    st.title("ğŸ“¦ å•†å“ç®¡ç†")
    
    # åŠ è¼‰å•†å“æ•¸æ“š
    products = load_data("products")
    
    # æ·»åŠ æ–°å•†å“
    with st.expander("æ·»åŠ æ–°å•†å“", expanded=False):
        with st.form("add_product_form"):
            col1, col2 = st.columns(2)
            with col1:
                name = st.text_input("å•†å“åç¨±*")
                category = st.text_input("å•†å“åˆ†é¡")
            with col2:
                cost_price = st.number_input("æˆæœ¬åƒ¹", min_value=0.0, value=0.0, step=1.0)
                selling_price = st.number_input("å”®åƒ¹", min_value=0.0, value=0.0, step=1.0)
                stock = st.number_input("åº«å­˜æ•¸é‡", min_value=0, value=0, step=1)
            
            note = st.text_area("å‚™è¨»")
            
            if st.form_submit_button("ä¿å­˜å•†å“"):
                if not name:
                    st.error("å•†å“åç¨±ä¸èƒ½ç‚ºç©º")
                else:
                    new_product = {
                        'id': str(len(products) + 1),
                        'name': name,
                        'category': category,
                        'cost_price': cost_price,
                        'selling_price': selling_price,
                        'stock': stock,
                        'note': note,
                        'created_at': datetime.now().isoformat(),
                        'updated_at': datetime.now().isoformat()
                    }
                    products[new_product['id']] = new_product
                    save_data("products", products)
                    st.success(f"å•†å“ '{name}' å·²æˆåŠŸæ·»åŠ ï¼")
                    st.rerun()
    
    # å•†å“åˆ—è¡¨
    st.subheader("å•†å“åˆ—è¡¨")
    
    if products:
        # è½‰æ›ç‚º DataFrame é¡¯ç¤º
        df_products = pd.DataFrame([{
            'ID': p['id'],
            'å•†å“åç¨±': p.get('name', ''),
            'åˆ†é¡': p.get('category', ''),
            'æˆæœ¬åƒ¹': p.get('cost_price', 0),
            'å”®åƒ¹': p.get('selling_price', 0),
            'åº«å­˜': p.get('stock', 0),
            'æ›´æ–°æ—¥æœŸ': p.get('updated_at', '').split('T')[0]
        } for p in products.values()])
        
        st.dataframe(
            df_products,
            use_container_width=True,
            hide_index=True,
            column_config={
                "æˆæœ¬åƒ¹": st.column_config.NumberColumn(format="$%.2f"),
                "å”®åƒ¹": st.column_config.NumberColumn(format="$%.2f")
            }
        )
    else:
        st.info("æš«ç„¡å•†å“æ•¸æ“š")

# å…¶ä»–é é¢çš„å¯¦ç¾...
elif st.session_state.current_page == "ä¾›æ‡‰å•†ç®¡ç†":
    st.title("ğŸ“¦ ä¾›æ‡‰å•†ç®¡ç†")

    suppliers = load_data("suppliers")
    products = load_data("products")
    sales_data = load_data("sales")
    sales = sales_data.get("sales", sales_data if isinstance(sales_data, list) else [])

    product_supplier = {p.get('id'): p.get('supplier_id') for p in products}
    supplier_map = {s.get('id'): s.get('name') for s in suppliers}

    col1, col2 = st.columns(2)
    with col1:
        start_date = st.date_input("é–‹å§‹æ—¥æœŸ", value=datetime.now() - timedelta(days=30))
    with col2:
        end_date = st.date_input("çµæŸæ—¥æœŸ", value=datetime.now())

    def parse_date(date_str: str):
        try:
            return datetime.fromisoformat(date_str.replace('Z', '+00:00'))
        except Exception:
            return None

    filtered_sales = []
    for s in sales:
        dt = parse_date(s.get('sale_date', ''))
        if dt and start_date <= dt.date() <= end_date:
            filtered_sales.append(s)

    stats = {sid: {'name': supplier_map.get(sid, sid), 'quantity': 0, 'amount': 0.0} for sid in supplier_map}

    for sale in filtered_sales:
        for item in sale.get('items', []):
            supplier_id = product_supplier.get(item.get('product_id'))
            if not supplier_id:
                continue
            q = item.get('quantity', 0)
            subtotal = item.get('subtotal')
            if subtotal is None:
                subtotal = item.get('unit_price', 0) * q - item.get('discount', 0)
            stats[supplier_id]['quantity'] += q
            stats[supplier_id]['amount'] += subtotal

    df = pd.DataFrame([
        {'ä¾›æ‡‰å•†': v['name'], 'éŠ·å”®æ•¸é‡': v['quantity'], 'éŠ·å”®é‡‘é¡': v['amount']}
        for v in stats.values()
    ])

    st.subheader("æœŸé–“éŠ·å”®å½™ç¸½")
    st.dataframe(df, use_container_width=True, hide_index=True,
                 column_config={'éŠ·å”®é‡‘é¡': st.column_config.NumberColumn(format="$%.2f")})
else:
    st.title(st.session_state.current_page)
    st.write("é–‹ç™¼ä¸­...")

# é è…³
st.write("---")
st.caption("Â© 2025 æ›¸æˆ¿è¨˜å¸³èˆ‡ç‡Ÿé‹ç®¡ç†ç³»çµ± - ç‰ˆæœ¬ 1.0.0")


===== build_static.py =====
import json
import os
import shutil
import re
from datetime import datetime
from pathlib import Path

from jinja2 import Environment, FileSystemLoader

# --- è¨­å®š ---
# å°ˆæ¡ˆæ ¹ç›®éŒ„
ROOT_DIR = Path(__file__).parent
# éœæ…‹ç¶²ç«™è¼¸å‡ºç›®éŒ„
DIST_DIR = ROOT_DIR / "docs"
# åŸå§‹è³‡æ–™ç›®éŒ„
DATA_DIR = ROOT_DIR / "data"
# åŸå§‹éœæ…‹è³‡æºç›®éŒ„ (CSS, JS)
STATIC_DIR = ROOT_DIR / "static"
# åŸå§‹ Jinja æ¨¡æ¿ç›®éŒ„
TEMPLATES_DIR = ROOT_DIR / "templates"


def setup_dist_directory():
    """å»ºç«‹ä¸€å€‹ä¹¾æ·¨çš„è¼¸å‡ºç›®éŒ„"""
    print(f"1. æ­£åœ¨æ¸…ç†ä¸¦å»ºç«‹è¼¸å‡ºç›®éŒ„: {DIST_DIR}")
    if DIST_DIR.exists():
        shutil.rmtree(DIST_DIR)
    DIST_DIR.mkdir(exist_ok=True)
    print("   âœ… è¼¸å‡ºç›®éŒ„å·²æº–å‚™å°±ç·’ã€‚")


def process_and_copy_assets():
    """
    è¤‡è£½éœæ…‹è³‡æºä¸¦å° JavaScript æª”æ¡ˆé€²è¡Œå…¨é¢æ”¹é€ ï¼Œä»¥é©æ‡‰éœæ…‹ç¶²ç«™çš„äº’å‹•æ¨¡æ“¬ã€‚
    """
    print("2. æ­£åœ¨è™•ç†èˆ‡è¤‡è£½éœæ…‹è³‡æº...")
    dist_static_dir = DIST_DIR / "static"
    shutil.copytree(STATIC_DIR, dist_static_dir, dirs_exist_ok=True)

    js_dir = dist_static_dir / "js"
    if not js_dir.exists():
        print("   âš ï¸ æœªæ‰¾åˆ° JavaScript ç›®éŒ„ï¼Œè·³éè™•ç†ã€‚")
        return

    print("   æ­£åœ¨å…¨é¢æ”¹é€  JavaScript æª”æ¡ˆä»¥é©æ‡‰éœæ…‹æ¨¡å¼...")
    for js_file in js_dir.glob("*.js"):
        content = js_file.read_text("utf-8")
        
        # --- æ­¥é©Ÿ 1: API è·¯å¾‘æ›¿æ› (ç”¨æ–¼åˆå§‹è³‡æ–™è¼‰å…¥) ---
        content = re.sub(r"/api/(\w+)/overview", r"./data/reports.json", content)
        content = re.sub(r"/api/(\w+)", r"./data/\1.json", content)

        # --- æ­¥é©Ÿ 2: ä¿®æ­£ purchases.js çš„è³‡æ–™è®€å–å•é¡Œ ---
        if js_file.name == 'purchases.js':
            content = content.replace('result.data', 'result')
            print(f"   - å·²ä¿®æ­£ {js_file.name} çš„è³‡æ–™è®€å–é‚è¼¯ã€‚")

        # --- æ­¥é©Ÿ 3: æ³¨å…¥å‰ç«¯äº’å‹•æ¨¡æ“¬ç¨‹å¼ç¢¼ ---
        
        # ç§»é™¤ç•°æ­¥é—œéµå­— `async`ï¼Œå› ç‚ºä¸å†æœ‰å¯¦éš›çš„ await
        content = re.sub(r'const handle.*? = async \(.*?\)', lambda m: m.group(0).replace('async ', ''), content)
        content = re.sub(r'const processCheckout = async \(\)', 'const processCheckout = ()', content)
        content = re.sub(r'const delete.*? = async \(.*?\)', lambda m: m.group(0).replace('async ', ''), content)

        # æ¨¡æ“¬ suppliers.js çš„æ–°å¢/ç·¨è¼¯
        if js_file.name == 'suppliers.js':
            submit_pattern = re.compile(r"const handleSubmitSupplier = \((?:.|\n)*?\{((?:.|\n)*?)\};", re.MULTILINE)
            delete_pattern = re.compile(r"const deleteSupplier = \((?:.|\n)*?\{((?:.|\n)*?)\};", re.MULTILINE)
            
            content = submit_pattern.sub(r"""
    const handleSubmitSupplier = (e) => {
        e.preventDefault();
        const supplierId = supplierForm.dataset.id;
        const isEdit = !!supplierId;
        const supplierData = {
            id: supplierId || `S_NEW_${Date.now()}`,
            name: document.getElementById('supplier-name').value.trim(),
            contact_person: document.getElementById('contact-person').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            payment_terms: document.getElementById('payment-terms').value,
            created_at: new Date().toISOString()
        };
        if (!supplierData.name || !supplierData.contact_person || !supplierData.phone) {
            window.app.ui.showNotification('error', 'è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ (*)');
            return;
        }
        if (isEdit) {
            const index = allSuppliers.findIndex(s => s.id === supplierId);
            if (index !== -1) allSuppliers[index] = { ...allSuppliers[index], ...supplierData };
        } else {
            allSuppliers.unshift(supplierData);
        }
        renderSuppliers(allSuppliers);
        closeSupplierModal();
        window.app.ui.showNotification('success', 'ä¾›æ‡‰å•†è³‡æ–™å·²æˆåŠŸæ¨¡æ“¬å„²å­˜ï¼');
    };
            """, content)
            
            content = delete_pattern.sub(r"""
    const deleteSupplier = (supplierId) => {
        allSuppliers = allSuppliers.filter(s => s.id !== supplierId);
        renderSuppliers(allSuppliers);
        window.app.ui.showNotification('success', 'ä¾›æ‡‰å•†å·²æ¨¡æ“¬åˆªé™¤');
    };
            """, content)
            print(f"   - å·²æ³¨å…¥ {js_file.name} çš„äº’å‹•æ¨¡æ“¬åŠŸèƒ½ã€‚")

        # æ¨¡æ“¬ members.js çš„æ–°å¢/ç·¨è¼¯
        if js_file.name == 'members.js':
            content = re.sub(r"const handleFormSubmit = async \((?:.|\n)*?\{((?:.|\n)*?)\};", r"""
    const handleFormSubmit = (e) => {
        e.preventDefault();
        const memberId = document.getElementById('member-id').value;
        const isEdit = !!memberId;
        const memberData = {
            id: memberId || `M_NEW_${Date.now()}`,
            name: document.getElementById('name').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim(),
            total_spent: isEdit ? (allMembers.find(m => m.id === memberId).total_spent || 0) : 0,
            member_level: document.getElementById('member-level').value,
            status: document.getElementById('status').value
        };
        if (!memberData.name || !memberData.phone) {
            window.app.ui.showNotification('error', 'è«‹å¡«å¯«å§“åèˆ‡é›»è©±');
            return;
        }
        if (isEdit) {
            const index = allMembers.findIndex(m => m.id === memberId);
            if (index !== -1) allMembers[index] = { ...allMembers[index], ...memberData };
        } else {
            allMembers.unshift(memberData);
        }
        renderMembers(allMembers);
        closeMemberModal();
        window.app.ui.showNotification('success', 'æœƒå“¡è³‡æ–™å·²æˆåŠŸæ¨¡æ“¬å„²å­˜ï¼');
    };
            """, content, flags=re.MULTILINE)
            content = re.sub(r"const deleteMember = async \((?:.|\n)*?\{((?:.|\n)*?)\};", r"""
    const deleteMember = (memberId) => {
        allMembers = allMembers.filter(m => m.id !== memberId);
        renderMembers(allMembers);
        window.app.ui.showNotification('success', 'æœƒå“¡å·²æ¨¡æ“¬åˆªé™¤');
    };
            """, content, flags=re.MULTILINE)
            print(f"   - å·²æ³¨å…¥ {js_file.name} çš„äº’å‹•æ¨¡æ“¬åŠŸèƒ½ã€‚")
        
        # æ¨¡æ“¬ sales.js çš„çµå¸³
        if js_file.name == 'sales.js':
            content = re.sub(r'const processCheckout = \(\) => \{((?:.|\n)*?)\};', r"""
    const processCheckout = () => {
        window.app.ui.showLoading('çµå¸³ä¸­...');
        setTimeout(() => {
            window.app.ui.hideLoading();
            window.app.ui.showNotification('success', 'çµå¸³æˆåŠŸï¼');
            cart = [];
            updateCartUI();
            checkoutModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }, 800);
    };
            """, content, flags=re.MULTILINE)
            print(f"   - å·²æ³¨å…¥ {js_file.name} çš„äº’å‹•æ¨¡æ“¬åŠŸèƒ½ã€‚")

        js_file.write_text(content, "utf-8")

    print("   âœ… éœæ…‹è³‡æºè™•ç†èˆ‡è¤‡è£½å®Œæˆã€‚")


def copy_data_files():
    """å°‡ data ç›®éŒ„ä¸‹çš„ JSON æª”æ¡ˆè¤‡è£½åˆ° dist/data ç›®éŒ„ï¼Œä¸¦æå–é™£åˆ—ã€‚"""
    print("3. æ­£åœ¨è¤‡è£½è³‡æ–™æª”æ¡ˆ...")
    dist_data_dir = DIST_DIR / "data"
    dist_data_dir.mkdir(exist_ok=True)

    for json_file in DATA_DIR.glob("*.json"):
        with open(json_file, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        if isinstance(data, dict) and len(data) == 1 and isinstance(list(data.values())[0], list):
            key = list(data.keys())[0]
            print(f"   - æ­£åœ¨æå– {json_file.name} ä¸­çš„ '{key}' é™£åˆ—...")
            data = data[key]
        
        elif json_file.name == "members.json" and isinstance(data, list) and data and 'members' in data[0]:
             print(f"   - æ­£åœ¨è™•ç† {json_file.name} çš„ç‰¹æ®Šçµæ§‹...")
             processed_data = []
             for item in data:
                 if 'members' in item and isinstance(item['members'], list):
                     processed_data.extend(item['members'])
                 else:
                     processed_data.append(item)
             data = processed_data

        (dist_data_dir / json_file.name).write_text(
            json.dumps(data, ensure_ascii=False, indent=2),
            encoding='utf-8'
        )
        print(f"   - å·²è¤‡è£½ä¸¦è™•ç† {json_file.name}")
        
    print("   âœ… è³‡æ–™æª”æ¡ˆè¤‡è£½å®Œæˆã€‚")


def render_and_fix_html_pages():
    """æ¸²æŸ“æ¨¡æ¿ã€å„²å­˜ç‚º HTMLï¼Œä¸¦ä¿®æ­£å…§éƒ¨é€£çµèˆ‡è³‡æºè·¯å¾‘ã€‚"""
    print("4. æ­£åœ¨æ¸²æŸ“ä¸¦ä¿®æ­£ HTML é é¢...")
    env = Environment(loader=FileSystemLoader(TEMPLATES_DIR), autoescape=True)

    pages_to_render = {
        "index.html": {"title": "å„€è¡¨æ¿"}, "products.html": {"title": "å•†å“ç®¡ç†"},
        "suppliers.html": {"title": "ä¾›æ‡‰å•†ç®¡ç†"}, "purchases.html": {"title": "é€²è²¨ç®¡ç†"},
        "purchase_form.html": {"title": "æ–°å¢é€²è²¨å–®", "today": datetime.now().strftime("%Y-%m-%d")},
        "sales.html": {"title": "éŠ·å”®ç®¡ç†"}, "members.html": {"title": "æœƒå“¡ç®¡ç†"},
        "reports.html": {"title": "å ±è¡¨åˆ†æ"},
    }

    for template_name, context in pages_to_render.items():
        template = env.get_template(template_name)
        rendered_html = template.render({"request": None, **context})
        
        # å°‡æ‰€æœ‰çµ•å°è·¯å¾‘æ”¹ç‚ºç›¸å°è·¯å¾‘
        rendered_html = re.sub(r'(href|src)="/', r'\1="./', rendered_html)
        rendered_html = re.sub(r'href="./(?!static)([^"]+)"', r'href="./\1.html"', rendered_html)
        rendered_html = re.sub(r'href="./index.html"', 'href="./index.html"', rendered_html) 
        rendered_html = re.sub(r'href="./purchases/new.html"', 'href="./purchase_form.html"', rendered_html)

        (DIST_DIR / template_name).write_text(rendered_html, encoding="utf-8")
        print(f"   - å·²æ¸²æŸ“ä¸¦ä¿®æ­£ {template_name}")
        
    print("   âœ… HTML é é¢è™•ç†å®Œæˆã€‚")


def main():
    """ä¸»åŸ·è¡Œå‡½æ•¸"""
    print("ğŸš€ é–‹å§‹å»ºç«‹éœæ…‹ç¶²ç«™...")
    
    setup_dist_directory()
    process_and_copy_assets()
    copy_data_files()
    render_and_fix_html_pages()
    
    print("\nâœ… éœæ…‹ç¶²ç«™å»ºç«‹æˆåŠŸï¼")
    print(f"   æ‰€æœ‰æª”æ¡ˆéƒ½å·²ç”Ÿæˆåœ¨ '{DIST_DIR.name}' ç›®éŒ„ä¸­ã€‚")
    print("   JS æª”æ¡ˆå·²è‡ªå‹•æ”¹é€ ï¼Œç¾åœ¨å¯ä»¥å®Œæ•´æ¨¡æ“¬æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤çš„äº’å‹•æ•ˆæœã€‚")


if __name__ == "__main__":
    main()

===== init_data.py =====
from main import initialize_data_files

if __name__ == '__main__':
    initialize_data_files()
    print("Data files initialized.")


===== main.py =====
try:
    from fastapi import FastAPI, HTTPException, Request, Depends, status
    from fastapi.staticfiles import StaticFiles
    from fastapi.responses import FileResponse, HTMLResponse, JSONResponse
    from fastapi.templating import Jinja2Templates
    from fastapi.middleware.cors import CORSMiddleware
    HAS_FASTAPI = True
except ModuleNotFoundError:  # pragma: no cover - fallback for test envs
    HAS_FASTAPI = False
    HTTPException = Exception

    class Dummy:
        def __init__(self, *args, **kwargs):
            pass

    Request = Depends = status = Dummy
    StaticFiles = Dummy
    FileResponse = HTMLResponse = JSONResponse = Dummy
    Jinja2Templates = Dummy
    CORSMiddleware = Dummy

    class DummyFastAPI:
        def __init__(self, *args, **kwargs):
            pass

        def add_middleware(self, *args, **kwargs):
            pass

        def mount(self, *args, **kwargs):
            pass

        def get(self, *args, **kwargs):
            def decorator(func):
                return func
            return decorator

        def post(self, *args, **kwargs):
            def decorator(func):
                return func
            return decorator

        def put(self, *args, **kwargs):
            def decorator(func):
                return func
            return decorator

        def delete(self, *args, **kwargs):
            def decorator(func):
                return func
            return decorator

    FastAPI = DummyFastAPI
from pathlib import Path
try:
    import uvicorn
except ModuleNotFoundError:  # pragma: no cover - optional in tests
    uvicorn = None
from typing import Dict, List, Optional, Any
import json
from datetime import datetime
import os
from services.report_service import ReportService
from utils import validate_required_fields
import logging

# é…ç½®æ—¥èªŒ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# åˆå§‹åŒ– FastAPI æ‡‰ç”¨
app = FastAPI(title="æ›¸æˆ¿è¨˜å¸³èˆ‡ç‡Ÿé‹ç®¡ç†ç³»çµ±")

# æ·»åŠ  CORS ä¸­é–“ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ç¢ºä¿æ•¸æ“šç›®éŒ„å­˜åœ¨
data_dir = Path("data")
data_dir.mkdir(exist_ok=True)

# è¨­ç½®éœæ…‹æ–‡ä»¶ç›®éŒ„
static_dir = Path("static")
static_dir.mkdir(exist_ok=True)
app.mount("/static", StaticFiles(directory=static_dir), name="static")

# è¨­ç½®æ¨¡æ¿ç›®éŒ„
templates_dir = Path("templates")
templates_dir.mkdir(exist_ok=True)
try:
    templates = Jinja2Templates(directory=templates_dir)
except Exception:  # pragma: no cover - allow tests without jinja2
    templates = None

# æ•¸æ“šç›®éŒ„
DATA_DIR = Path("data")
DATA_DIR.mkdir(exist_ok=True)

# åˆå§‹åŒ–æ•¸æ“šæ–‡ä»¶
DATA_FILES = ["products", "suppliers", "purchases", "sales", "members", "payments", "discounts"]

def initialize_data_files():
    """ç¢ºä¿æ‰€æœ‰éœ€è¦çš„æ•¸æ“šæ–‡ä»¶éƒ½å­˜åœ¨ä¸”ç‚ºæœ‰æ•ˆJSON"""
    for file_name in DATA_FILES:
        file_path = DATA_DIR / f"{file_name}.json"
        if not file_path.exists():
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump([], f, ensure_ascii=False, indent=2)
            logger.info(f"Created empty data file: {file_path}")
        else:
            # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦ç‚ºæœ‰æ•ˆçš„JSON
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    json.load(f)
            except json.JSONDecodeError:
                logger.warning(f"Invalid JSON in {file_path}, resetting to empty list")
                with open(file_path, 'w', encoding='utf-8') as f:
                    json.dump([], f, ensure_ascii=False, indent=2)

# æ‡‰ç”¨å•Ÿå‹•æ™‚åˆå§‹åŒ–æ•¸æ“šæ–‡ä»¶
initialize_data_files()

# åŠ è¼‰æ•¸æ“š
def load_data(collection_name: str) -> List[Dict]:
    """Load data from a JSON file and ensure it's a list."""
    file_path = DATA_DIR / f"{collection_name}.json"
    if file_path.exists():
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
                if isinstance(data, dict):
                    # handle legacy structure like {"sales": [...]} or {"members": [...]}  
                    if len(data) == 1 and isinstance(next(iter(data.values())), list):
                        logger.info(f"Extracting array from wrapper in {file_path}")
                        data = next(iter(data.values()))
                    else:
                        logger.warning(f"Data in {file_path} is a dict, converting values to list")
                        data = [data]
                if not isinstance(data, list):
                    logger.warning(f"Data in {file_path} is not a list, converting to list")
                    data = [data] if data else []
                return data
        except json.JSONDecodeError as e:
            logger.error(f"Error loading {file_path}: {e}")
            return []
    return []

# ä¿å­˜æ•¸æ“š
def save_data(collection_name: str, data: List[Dict]):
    """Save data to a JSON file, ensuring it's a list."""
    file_path = DATA_DIR / f"{collection_name}.json"
    try:
        # Ensure the directory exists
        file_path.parent.mkdir(parents=True, exist_ok=True)
        # Ensure data is a list
        if not isinstance(data, list):
            logger.warning(f"Data for {collection_name} is not a list, converting to list")
            data = [data] if data else []
        # Save with pretty print
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2, default=str)
    except Exception as e:
        logger.error(f"Error saving {file_path}: {e}")
        raise

# é¦–é 
@app.get("/", response_class=HTMLResponse)
async def read_root(request: Request):
    return templates.TemplateResponse("index.html", {"request": request, "title": "é¦–é "})

# å•†å“é é¢
@app.get("/products", response_class=HTMLResponse)
async def products_page(request: Request):
    return templates.TemplateResponse("products.html", {
        "request": request,
        "title": "å•†å“ç®¡ç†"
    })

# ä¾›æ‡‰å•†é é¢
@app.get("/suppliers", response_class=HTMLResponse)
async def suppliers_page(request: Request):
    return templates.TemplateResponse("suppliers.html", {
        "request": request, 
        "title": "ä¾›æ‡‰å•†ç®¡ç†"
    })
    
# é€²è²¨é é¢
@app.get("/purchases", response_class=HTMLResponse)
async def purchases_page(request: Request):
    return templates.TemplateResponse("purchases.html", {
        "request": request,
        "title": "é€²è²¨ç®¡ç†"
    })

@app.get("/purchases/new", response_class=HTMLResponse)
async def new_purchase_page(request: Request):
    return templates.TemplateResponse("purchase_form.html", {
        "request": request,
        "title": "æ–°å¢é€²è²¨å–®",
        "today": datetime.now().strftime("%Y-%m-%d")
    })

# æœƒå“¡é é¢
@app.get("/members", response_class=HTMLResponse)
async def members_page(request: Request):
    return templates.TemplateResponse("members.html", {
        "request": request,
        "title": "æœƒå“¡ç®¡ç†"
    })

# å ±è¡¨åˆ†æé é¢
@app.get("/reports", response_class=HTMLResponse)
async def reports_page(request: Request):
    """é¡¯ç¤ºç°¡æ˜“å ±è¡¨åˆ†æä»‹é¢"""
    return templates.TemplateResponse("reports.html", {
        "request": request,
        "title": "å ±è¡¨åˆ†æ"
    })

# å•†å“ç›¸é—œ API
@app.get("/api/products")
async def get_products(supplier_id: str | None = None, sort_by: str | None = None, order: str = "asc"):
    """å–å¾—å•†å“åˆ—è¡¨ï¼Œæ”¯æ´æŒ‰ä¾›æ‡‰å•†ç¯©é¸èˆ‡æ’åº"""
    products = load_data("products") or []

    if supplier_id:
        products = [p for p in products if p.get("supplier_id") == supplier_id]

    if sort_by:
        reverse = (order == "desc")
        products.sort(
            key=lambda x: x.get(sort_by) if isinstance(x.get(sort_by), (int, float)) else str(x.get(sort_by, "")),
            reverse=reverse,
        )

    return products

@app.get("/api/products/{product_id}")
async def get_product(product_id: str):
    products = load_data("products")
    product = next((p for p in products if p["id"] == product_id), None)
    if not product:
        raise HTTPException(status_code=404, detail="å•†å“ä¸å­˜åœ¨")
    return product

@app.post("/api/products")
async def create_product(product: dict):
    products = load_data("products")
    if not isinstance(products, list):
        products = []
    product["id"] = f"P{len(products) + 1:03d}"
    product["created_at"] = datetime.now().isoformat()
    product["updated_at"] = datetime.now().isoformat()
    products.append(product)
    save_data("products", products)
    return {"message": "å•†å“æ–°å¢æˆåŠŸ", "id": product["id"]}

@app.put("/api/products/{product_id}")
async def update_product(product_id: str, product_data: dict):
    products = load_data("products")
    if not isinstance(products, list):
        products = []

    product_index = next((i for i, p in enumerate(products) if p["id"] == product_id), None)
    if product_index is None:
        raise HTTPException(status_code=404, detail="å•†å“ä¸å­˜åœ¨")

    existing = products[product_index]

    # åƒ…å…è¨±ä¿®æ”¹ç‰¹å®šæ¬„ä½ï¼Œåº«å­˜ã€æˆæœ¬åŠä¾›æ‡‰å•†ä¸å¯è®Šå‹•
    allowed_fields = {"name", "category", "sale_price", "description", "unit", "min_stock"}
    for field in allowed_fields:
        if field in product_data:
            existing[field] = product_data[field]

    existing["created_at"] = existing.get("created_at", datetime.now().isoformat())
    existing["updated_at"] = datetime.now().isoformat()

    products[product_index] = existing
    save_data("products", products)
    return {"message": "å•†å“æ›´æ–°æˆåŠŸ", "id": product_id}

@app.delete("/api/products/{product_id}")
async def delete_product(product_id: str):
    """å•†å“ä¸å¯åˆªé™¤"""
    raise HTTPException(status_code=405, detail="å•†å“ä¸å¯åˆªé™¤")

# éŠ·å”®ç›¸é—œ API
@app.get("/sales", response_class=HTMLResponse)
async def sales_page(request: Request):
    return templates.TemplateResponse("sales.html", {
        "request": request,
        "title": "éŠ·å”®ç®¡ç†"
    })

# éŠ·å”®è¨˜éŒ„é é¢
@app.get("/sales/history", response_class=HTMLResponse)
async def sales_history_page(request: Request):
    return templates.TemplateResponse("sales_history.html", {
        "request": request,
        "title": "éŠ·å”®è¨˜éŒ„"
    })

@app.get("/api/sales")
async def get_sales():
    sales_data = load_data("sales")
    # ç¢ºä¿è¿”å›çš„æ˜¯åˆ—è¡¨
    if isinstance(sales_data, dict) and 'sales' in sales_data:
        return sales_data['sales']
    return sales_data or []

@app.get("/api/sales/{sale_id}")
async def get_sale(sale_id: str):
    sales = load_data("sales")
    sale = next((s for s in sales if s.get("id") == sale_id), None)
    if not sale:
        raise HTTPException(status_code=404, detail="éŠ·å”®è¨˜éŒ„ä¸å­˜åœ¨")
    return sale

@app.post("/api/sales")
async def create_sale(sale: dict):
    sales = load_data("sales")
    products = load_data("products")
    discounts = load_data("discounts")

    error = validate_required_fields(sale, ["items"])
    if error:
        raise HTTPException(status_code=400, detail=error)
    if not isinstance(sale["items"], list) or not sale["items"]:
        raise HTTPException(status_code=400, detail="éŠ·å”®é …ç›®ä¸èƒ½ç‚ºç©º")

    now = datetime.now()
    sale_id = f"S{now.strftime('%Y%m%d%H%M%S')}"

    def calc_discount(pid: str, qty: int, price: float) -> float:
        applicable = [d for d in discounts if d.get("target_type") == "product" and d.get("target_id") == pid]
        product = next((p for p in products if p["id"] == pid), None)
        if product and product.get("category"):
            applicable += [d for d in discounts if d.get("target_type") == "category" and d.get("target_id") == product["category"]]
        applicable += [d for d in discounts if d.get("target_type") == "all"]

        now_dt = datetime.now()
        applicable = [
            d for d in applicable
            if (not d.get("valid_from") or datetime.fromisoformat(d["valid_from"]) <= now_dt) and
               (not d.get("valid_to") or datetime.fromisoformat(d["valid_to"]) >= now_dt)
        ]
        if not applicable:
            return 0.0
        disc = applicable[0]
        if disc.get("discount_type") == "percentage":
            return price * qty * (float(disc.get("value", 0)) / 100)
        return float(disc.get("value", 0)) * qty

    subtotal = 0.0
    discount_total = 0.0

    for item in sale.get("items", []):
        product = next((p for p in products if p["id"] == item["product_id"]), None)
        if not product:
            continue
        quantity = int(item.get("quantity", 0))
        # å–å¾—å•†å“å”®åƒ¹
        unit_price = float(item.get("unit_price", product.get("sale_price", 0)))

        # åº«å­˜æª¢æŸ¥ï¼Œé¿å…è² æ•¸
        if product.get("stock", 0) < quantity:
            raise HTTPException(status_code=400, detail=f"å•†å“ {product.get('name')} åº«å­˜ä¸è¶³")

        subtotal += unit_price * quantity
        discount_total += calc_discount(product["id"], quantity, unit_price)

        product["stock"] -= quantity
        product["updated_at"] = now.isoformat()

    manual_type = sale.get("manual_discount_type")
    manual_value = float(sale.get("manual_discount_value", 0) or 0)
    manual_discount = 0.0
    if manual_type == "percentage":
        manual_discount = subtotal * (manual_value / 100)
    elif manual_type == "amount":
        manual_discount = manual_value
    discount_total += manual_discount

    total = subtotal - discount_total
    amount_received = float(sale.get("amount_received", total))
    if amount_received < total:
        raise HTTPException(status_code=400, detail="å¯¦æ”¶é‡‘é¡ä¸è¶³")

    sale_data = {
        "id": sale_id,
        "items": sale.get("items", []),
        "member_id": sale.get("member_id"),
        "subtotal": subtotal,
        "discount": discount_total,
        "total": total,
        "payment_method": sale.get("payment_method", "cash"),
        "amount_received": amount_received,
        "change": amount_received - total,
        "manual_discount_type": manual_type,
        "manual_discount_value": manual_value,
        "created_at": now.isoformat(),
        "cashier": sale.get("cashier", "ç³»çµ±ç®¡ç†å“¡")
    }

    sales.append(sale_data)
    save_data("sales", sales)
    save_data("products", products)

    if sale_data.get("member_id"):
        members = load_data("members")
        member = next((m for m in members if m["id"] == sale_data["member_id"]), None)
        if member:
            member["total_spent"] = member.get("total_spent", 0) + total
            member["points"] = member.get("points", 0) + int(total // 100)
            member["updated_at"] = now.isoformat()
            save_data("members", members)

    return {"message": "éŠ·å”®è¨˜éŒ„å·²å»ºç«‹", "sale_id": sale_id}

# é€²è²¨ç›¸é—œ API
@app.get("/api/purchases")
async def get_purchases():
    """ç²å–æ‰€æœ‰é€²è²¨è¨˜éŒ„"""
    try:
        purchases = load_data("purchases")
        return {"data": purchases}
    except Exception as e:
        logger.error(f"Error getting purchases: {e}")
        raise HTTPException(status_code=500, detail="ç²å–é€²è²¨è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤")

@app.get("/api/purchases/{purchase_id}")
async def get_purchase(purchase_id: str):
    """æ ¹æ“šIDç²å–å–®ç­†é€²è²¨è¨˜éŒ„"""
    try:
        purchases = load_data("purchases")
        purchase = next((p for p in purchases if str(p.get("id")) == str(purchase_id)), None)
        if not purchase:
            raise HTTPException(status_code=404, detail="é€²è²¨è¨˜éŒ„ä¸å­˜åœ¨")
        
        # ç²å–ä¾›æ‡‰å•†ä¿¡æ¯
        suppliers = load_data("suppliers")
        supplier = next((s for s in suppliers if str(s.get("id")) == str(purchase.get("supplier_id"))), {})
        purchase["supplier_name"] = supplier.get("name", "æœªçŸ¥ä¾›æ‡‰å•†")
        
        # ç²å–å•†å“ä¿¡æ¯
        products = load_data("products")
        for item in purchase.get("items", []):
            product = next((p for p in products if str(p.get("id")) == str(item.get("product_id"))), {})
            item["product_name"] = product.get("name", "æœªçŸ¥å•†å“")
        
        return {"data": purchase}
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error getting purchase {purchase_id}: {e}")
        raise HTTPException(status_code=500, detail="ç²å–é€²è²¨è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤")

@app.post("/api/purchases")
async def create_purchase(purchase: dict):
    """å‰µå»ºæ–°çš„é€²è²¨è¨˜éŒ„"""
    try:
        error = validate_required_fields(purchase, ["supplier_id", "items"])
        if error:
            raise HTTPException(status_code=400, detail=error)
        if not isinstance(purchase["items"], list):
            raise HTTPException(status_code=400, detail="é€²è²¨é …ç›®æ ¼å¼éŒ¯èª¤")
        
        # è¼‰å…¥ç¾æœ‰æ•¸æ“š
        purchases = load_data("purchases")
        products = load_data("products")
        
        # ç”Ÿæˆå”¯ä¸€ID
        purchase_id = f"P{len(purchases) + 1:04d}"
        now = datetime.now().isoformat()
        
        # è¨ˆç®—ç¸½é‡‘é¡
        subtotal = 0
        for item in purchase["items"]:
            product = next((p for p in products if str(p.get("id")) == str(item.get("product_id"))), None)
            if not product:
                raise HTTPException(status_code=400, detail=f"æ‰¾ä¸åˆ°å•†å“ ID: {item.get('product_id')}")
            
            quantity = int(item.get("quantity", 0))
            unit_price = float(item.get("unit_price", 0))
            item_total = quantity * unit_price
            subtotal += item_total
            
            # æ›´æ–°å•†å“åº«å­˜ï¼ˆå¦‚æœç‹€æ…‹ç‚ºå·²æ¥æ”¶ï¼‰
            if purchase.get("status") == "received":
                product["stock"] = product.get("stock", 0) + quantity
                product["updated_at"] = now
        
        # è¨ˆç®—ç¨…é‡‘å’Œç¸½é‡‘é¡
        tax_rate = float(purchase.get("tax_rate", 0)) / 100
        tax = subtotal * tax_rate
        shipping_cost = float(purchase.get("shipping_cost", 0))
        total_amount = subtotal + tax + shipping_cost
        
        # å‰µå»ºæ–°çš„é€²è²¨è¨˜éŒ„
        new_purchase = {
            "id": purchase_id,
            "purchase_number": f"PO-{datetime.now().strftime('%Y%m%d')}-{len(purchases) + 1:04d}",
            "supplier_id": purchase.get("supplier_id"),
            "purchase_date": purchase.get("purchase_date", now),
            "expected_delivery_date": purchase.get("expected_delivery_date"),
            "status": purchase.get("status", "pending"),
            "shipping_fee": shipping_cost,
            "tax_rate": tax_rate * 100,
            "notes": purchase.get("notes", ""),
            "items": [{
                "product_id": item.get("product_id"),
                "quantity": int(item.get("quantity", 0)),
                "unit_price": float(item.get("unit_price", 0)),
                "product_name": next((p.get("name", "") for p in products if str(p.get("id")) == str(item.get("product_id"))), "æœªçŸ¥å•†å“")
            } for item in purchase["items"]],
            "subtotal": subtotal,
            "tax": tax,
            "total_amount": total_amount,
            "payment_status": purchase.get("payment_status", "unpaid"),
            "created_at": now,
            "updated_at": now,
            "created_by": "system"
        }
        
        # ä¿å­˜æ›´æ–°å¾Œçš„å•†å“æ•¸æ“š
        save_data("products", products)
        
        # æ·»åŠ æ–°çš„é€²è²¨è¨˜éŒ„ä¸¦ä¿å­˜
        purchases.append(new_purchase)
        save_data("purchases", purchases)
        
        return {"message": "é€²è²¨è¨˜éŒ„å‰µå»ºæˆåŠŸ", "data": new_purchase}
        
    except HTTPException:
        raise
    except ValueError as e:
        raise HTTPException(status_code=400, detail=f"æ•¸æ“šæ ¼å¼éŒ¯èª¤: {str(e)}")
    except Exception as e:
        logger.error(f"Error creating purchase: {e}")
        raise HTTPException(status_code=500, detail="å‰µå»ºé€²è²¨è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤")

@app.put("/api/purchases/{purchase_id}")
async def update_purchase(purchase_id: str, purchase_data: dict):
    """æ›´æ–°é€²è²¨è¨˜éŒ„"""
    purchases = load_data("purchases")
    purchase_index = next((i for i, p in enumerate(purchases) if p["id"] == purchase_id), None)
    
    if purchase_index is None:
        raise HTTPException(status_code=404, detail="é€²è²¨è¨˜éŒ„ä¸å­˜åœ¨")
    
    old_purchase = purchases[purchase_index]
    
    # æ›´æ–°é€²è²¨è¨˜éŒ„
    updated_purchase = {**old_purchase, **purchase_data}
    updated_purchase["updated_at"] = datetime.now().isoformat()
    
    # å¦‚æœç‹€æ…‹å¾å…¶ä»–è®Šæ›´ç‚ºå·²æ¥æ”¶ï¼Œå‰‡æ›´æ–°åº«å­˜
    if old_purchase["status"] != "received" and updated_purchase["status"] == "received":
        update_inventory_for_purchase(updated_purchase)
    
    purchases[purchase_index] = updated_purchase
    save_data("purchases", purchases)
    
    return updated_purchase

@app.delete("/api/purchases/{purchase_id}")
async def delete_purchase(purchase_id: str):
    """åˆªé™¤é€²è²¨è¨˜éŒ„"""
    purchases = load_data("purchases")
    purchase_index = next((i for i, p in enumerate(purchases) if p["id"] == purchase_id), None)
    
    if purchase_index is None:
        raise HTTPException(status_code=404, detail="é€²è²¨è¨˜éŒ„ä¸å­˜åœ¨")
    
    # æª¢æŸ¥æ˜¯å¦å¯ä»¥åˆªé™¤ï¼ˆä¾‹å¦‚ï¼šå·²å®Œæˆçš„é€²è²¨å¯èƒ½ä¸å…è¨±åˆªé™¤ï¼‰
    purchase = purchases[purchase_index]
    if purchase.get("status") == "received":
        raise HTTPException(status_code=400, detail="å·²å®Œæˆçš„é€²è²¨è¨˜éŒ„ç„¡æ³•åˆªé™¤")
    
    # å¾åˆ—è¡¨ä¸­ç§»é™¤
    deleted_purchase = purchases.pop(purchase_index)
    save_data("purchases", purchases)
    
    return {"message": "é€²è²¨è¨˜éŒ„å·²åˆªé™¤", "purchase": deleted_purchase}

def update_inventory_for_purchase(purchase: Dict):
    """æ›´æ–°åº«å­˜ï¼ˆç•¶é€²è²¨å–®è¢«æ¨™è¨˜ç‚ºå·²æ¥æ”¶æ™‚èª¿ç”¨ï¼‰"""
    products = load_data("products")
    updated = False
    
    for item in purchase.get("items", []):
        product_id = item.get("product_id")
        quantity = int(item.get("quantity", 0))
        
        # æ‰¾åˆ°å°æ‡‰çš„ç”¢å“ä¸¦æ›´æ–°åº«å­˜
        for product in products:
            if product["id"] == product_id:
                product["stock"] = str(int(product.get("stock", 0)) + quantity)
                product["updated_at"] = datetime.now().isoformat()
                updated = True
                break
    
    if updated:
        save_data("products", products)

# æœƒå“¡ç›¸é—œ API
@app.get("/api/members")
async def get_members():
    return load_data("members")

@app.get("/api/members/{member_id}")
async def get_member(member_id: str):
    members = load_data("members")
    member = next((m for m in members if m["id"] == member_id), None)
    if not member:
        raise HTTPException(status_code=404, detail="æœƒå“¡ä¸å­˜åœ¨")
    return member

@app.post("/api/members")
async def create_member(member: dict):
    members = load_data("members")
    if not isinstance(members, list):
        members = []

    error = validate_required_fields(member, ["name", "phone"])
    if error:
        raise HTTPException(status_code=400, detail=error)
        
    # æª¢æŸ¥é›»è©±æ˜¯å¦å·²å­˜åœ¨
    if any(m.get('phone') == member.get('phone') for m in members):
        raise HTTPException(status_code=400, detail="æ­¤é›»è©±è™Ÿç¢¼å·²è¢«ä½¿ç”¨")
    
    # ç”Ÿæˆæœƒå“¡ç·¨è™Ÿ
    member_id = f"M{len(members) + 1:04d}"
    
    member_data = {
        "id": member_id,
        "name": member.get("name", ""),
        "phone": member.get("phone", ""),
        "email": member.get("email", ""),
        "birthday": member.get("birthday"),
        "member_level": member.get("member_level", "standard"),
        "status": member.get("status", "active"),
        "address": member.get("address", ""),
        "notes": member.get("notes", ""),
        "total_spent": 0,
        "points": 0,
        "created_at": datetime.now().isoformat(),
        "updated_at": datetime.now().isoformat()
    }
    
    members.append(member_data)
    save_data("members", members)
    return {"message": "æœƒå“¡æ–°å¢æˆåŠŸ", "id": member_id}

@app.put("/api/members/{member_id}")
async def update_member(member_id: str, member_data: dict):
    members = load_data("members")
    if not isinstance(members, list):
        members = []
    
    member_index = next((i for i, m in enumerate(members) if m["id"] == member_id), None)
    if member_index is None:
        raise HTTPException(status_code=404, detail="æœƒå“¡ä¸å­˜åœ¨")
    
    # æª¢æŸ¥é›»è©±æ˜¯å¦å·²è¢«å…¶ä»–æœƒå“¡ä½¿ç”¨
    if any(m.get('phone') == member_data.get('phone') and m['id'] != member_id for m in members):
        raise HTTPException(status_code=400, detail="æ­¤é›»è©±è™Ÿç¢¼å·²è¢«å…¶ä»–æœƒå“¡ä½¿ç”¨")
    
    # ä¿ç•™åŸå§‹æ•¸æ“š
    original_member = members[member_index]
    
    # æ›´æ–°æœƒå“¡è³‡æ–™
    updated_member = {
        **original_member,
        "name": member_data.get("name", original_member.get("name", "")),
        "phone": member_data.get("phone", original_member.get("phone", "")),
        "email": member_data.get("email", original_member.get("email", "")),
        "birthday": member_data.get("birthday", original_member.get("birthday")),
        "member_level": member_data.get("member_level", original_member.get("member_level", "standard")),
        "status": member_data.get("status", original_member.get("status", "active")),
        "address": member_data.get("address", original_member.get("address", "")),
        "notes": member_data.get("notes", original_member.get("notes", "")),
        "updated_at": datetime.now().isoformat()
    }
    
    members[member_index] = updated_member
    save_data("members", members)
    return {"message": "æœƒå“¡è³‡æ–™å·²æ›´æ–°", "id": member_id}

@app.delete("/api/members/{member_id}")
async def delete_member(member_id: str):
    members = load_data("members")
    if not isinstance(members, list):
        members = []
    
    member_index = next((i for i, m in enumerate(members) if m["id"] == member_id), None)
    if member_index is None:
        raise HTTPException(status_code=404, detail="æœƒå“¡ä¸å­˜åœ¨")
    
    # æª¢æŸ¥æ˜¯å¦æœ‰é—œè¯çš„éŠ·å”®è¨˜éŒ„
    sales = load_data("sales") or []
    if any(sale.get("member_id") == member_id for sale in sales):
        raise HTTPException(status_code=400, detail="ç„¡æ³•åˆªé™¤ï¼Œè©²æœƒå“¡å·²æœ‰æ¶ˆè²»è¨˜éŒ„")
    
    # åˆªé™¤æœƒå“¡
    del members[member_index]
    save_data("members", members)
    
    return {"message": "æœƒå“¡å·²åˆªé™¤", "id": member_id}

# ä¾›æ‡‰å•†ç›¸é—œ API
@app.get("/api/suppliers")
async def get_suppliers():
    return load_data("suppliers")

@app.get("/api/suppliers/{supplier_id}")
async def get_supplier(supplier_id: str):
    suppliers = load_data("suppliers")
    supplier = next((s for s in suppliers if s["id"] == supplier_id), None)
    if not supplier:
        raise HTTPException(status_code=404, detail="ä¾›æ‡‰å•†ä¸å­˜åœ¨")
    return supplier

@app.post("/api/suppliers")
async def create_supplier(supplier: dict):
    suppliers = load_data("suppliers")
    error = validate_required_fields(supplier, ["name"])
    if error:
        raise HTTPException(status_code=400, detail=error)
    supplier["id"] = f"S{len(suppliers) + 1:03d}"
    supplier["created_at"] = datetime.now().isoformat()
    suppliers.append(supplier)
    save_data("suppliers", suppliers)
    return {"message": "ä¾›æ‡‰å•†æ–°å¢æˆåŠŸ", "id": supplier["id"]}

@app.put("/api/suppliers/{supplier_id}")
async def update_supplier(supplier_id: str, supplier_data: dict):
    suppliers = load_data("suppliers")
    index = next((i for i, s in enumerate(suppliers) if s["id"] == supplier_id), None)
    if index is None:
        raise HTTPException(status_code=404, detail="ä¾›æ‡‰å•†ä¸å­˜åœ¨")
    
    # ä¿ç•™å‰µå»ºæ™‚é–“ï¼Œæ›´æ–°å…¶ä»–æ¬„ä½
    supplier_data["id"] = supplier_id
    supplier_data["created_at"] = suppliers[index].get("created_at", datetime.now().isoformat())
    supplier_data["updated_at"] = datetime.now().isoformat()
    
    suppliers[index] = supplier_data
    save_data("suppliers", suppliers)
    
    return {"message": "ä¾›æ‡‰å•†æ›´æ–°æˆåŠŸ", "id": supplier_id}

@app.delete("/api/suppliers/{supplier_id}")
async def delete_supplier(supplier_id: str):
    suppliers = load_data("suppliers")
    supplier_ids = [s["id"] for s in suppliers]
    
    if supplier_id not in supplier_ids:
        raise HTTPException(status_code=404, detail="ä¾›æ‡‰å•†ä¸å­˜åœ¨")
    
    # æª¢æŸ¥æ˜¯å¦æœ‰ç›¸é—œçš„é€²è²¨æˆ–ä»˜æ¬¾è¨˜éŒ„
    purchases = load_data("purchases")
    payments = load_data("payments")

    has_related_purchases = any(p["supplier_id"] == supplier_id for p in purchases)
    has_related_payments = any(pay.get("supplier_id") == supplier_id for pay in payments)

    if has_related_purchases or has_related_payments:
        raise HTTPException(
            status_code=400,
            detail="ç„¡æ³•åˆªé™¤è©²ä¾›æ‡‰å•†ï¼Œå› ç‚ºæœ‰ç›¸é—œçš„é€²è²¨æˆ–ä»˜æ¬¾è¨˜éŒ„"
        )
    
    # åˆªé™¤ä¾›æ‡‰å•†
    updated_suppliers = [s for s in suppliers if s["id"] != supplier_id]
    save_data("suppliers", updated_suppliers)

    return {"message": "ä¾›æ‡‰å•†å·²åˆªé™¤", "id": supplier_id}

# ä»˜æ¬¾è¨˜éŒ„ç›¸é—œ API
@app.get("/api/payments")
async def get_payments():
    return load_data("payments")


@app.get("/api/payments/{payment_id}")
async def get_payment(payment_id: str):
    payments = load_data("payments")
    payment = next((p for p in payments if p["id"] == payment_id), None)
    if not payment:
        raise HTTPException(status_code=404, detail="ä»˜æ¬¾ç´€éŒ„ä¸å­˜åœ¨")
    return payment


@app.post("/api/payments")
async def create_payment(payment: dict):
    payments = load_data("payments")
    purchases = load_data("purchases")

    error = validate_required_fields(payment, ["supplier_id", "amount"])
    if error:
        raise HTTPException(status_code=400, detail=error)
    if float(payment.get("amount", 0)) <= 0:
        raise HTTPException(status_code=400, detail="ä»˜æ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼0")

    payment_id = f"PM{len(payments) + 1:04d}"
    now = datetime.now().isoformat()

    payment_data = {
        "id": payment_id,
        "supplier_id": payment.get("supplier_id"),
        "amount": float(payment.get("amount", 0)),
        "payment_date": payment.get("payment_date", now),
        "notes": payment.get("notes", ""),
        "purchase_ids": payment.get("purchase_ids", []),
        "created_at": now,
    }

    payments.append(payment_data)

    for pid in payment_data["purchase_ids"]:
        purchase = next((p for p in purchases if p.get("id") == pid), None)
        if purchase:
            purchase["payment_status"] = "paid"
            purchase["paid"] = True
            purchase["paid_date"] = now

    save_data("payments", payments)
    save_data("purchases", purchases)

    return {"message": "ä»˜æ¬¾è¨˜éŒ„å·²å»ºç«‹", "id": payment_id}

# æŠ˜æ‰£ç›¸é—œ API
@app.get("/api/discounts")
async def get_discounts():
    return load_data("discounts")


@app.get("/api/discounts/{discount_id}")
async def get_discount(discount_id: str):
    discounts = load_data("discounts")
    discount = next((d for d in discounts if d["id"] == discount_id), None)
    if not discount:
        raise HTTPException(status_code=404, detail="æŠ˜æ‰£ä¸å­˜åœ¨")
    return discount


@app.post("/api/discounts")
async def create_discount(discount: dict):
    discounts = load_data("discounts")
    discount_id = f"D{len(discounts) + 1:04d}"
    now = datetime.now().isoformat()

    if not discount.get("name"):
        raise HTTPException(status_code=400, detail="æŠ˜æ‰£åç¨±ä¸èƒ½ç‚ºç©º")
    if discount.get("value") is None:
        raise HTTPException(status_code=400, detail="æŠ˜æ‰£å€¼å¿…é ˆæä¾›")

    discount_data = {
        "id": discount_id,
        "name": discount.get("name", ""),
        "discount_type": discount.get("discount_type", "percentage"),
        "value": float(discount.get("value", 0)),
        "target_type": discount.get("target_type", "product"),
        "target_id": discount.get("target_id"),
        "valid_from": discount.get("valid_from"),
        "valid_to": discount.get("valid_to"),
        "created_at": now,
        "updated_at": now,
    }

    discounts.append(discount_data)
    save_data("discounts", discounts)
    return {"message": "æŠ˜æ‰£å·²å»ºç«‹", "id": discount_id}


@app.put("/api/discounts/{discount_id}")
async def update_discount(discount_id: str, discount: dict):
    discounts = load_data("discounts")
    index = next((i for i, d in enumerate(discounts) if d["id"] == discount_id), None)
    if index is None:
        raise HTTPException(status_code=404, detail="æŠ˜æ‰£ä¸å­˜åœ¨")

    discount["id"] = discount_id
    discount["created_at"] = discounts[index].get("created_at")
    discount["updated_at"] = datetime.now().isoformat()
    discounts[index] = discount
    save_data("discounts", discounts)
    return {"message": "æŠ˜æ‰£å·²æ›´æ–°", "id": discount_id}


@app.delete("/api/discounts/{discount_id}")
async def delete_discount(discount_id: str):
    discounts = load_data("discounts")
    index = next((i for i, d in enumerate(discounts) if d["id"] == discount_id), None)
    if index is None:
        raise HTTPException(status_code=404, detail="æŠ˜æ‰£ä¸å­˜åœ¨")
    discounts.pop(index)
    save_data("discounts", discounts)
    return {"message": "æŠ˜æ‰£å·²åˆªé™¤", "id": discount_id}

# å ±è¡¨ç›¸é—œ API
@app.get("/api/reports/overview")
async def get_report_overview(start_date: str = None, end_date: str = None):
    """è¿”å›ç°¡æ˜“éŠ·å”®å ±è¡¨æ•¸æ“š"""
    service = ReportService(str(DATA_DIR))
    report = service.get_sales_report(start_date, end_date)
    return report


# å•Ÿå‹•æœå‹™
if __name__ == "__main__":
    try:
        logger.info("Starting server...")
        uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True, log_level="info")
    except Exception as e:
        logger.error(f"Failed to start server: {e}")
        raise

===== models.py =====
from datetime import datetime, date
from typing import List, Dict, Optional, Literal
from dataclasses import dataclass, field, asdict
from uuid import uuid4

# ä¾›æ‡‰å•†è³‡æ–™æ¨¡å‹
@dataclass
class Supplier:
    name: str  # ä¾›æ‡‰å•†åç¨±
    contact: str = ""  # è¯çµ¡æ–¹å¼
    payment_cycle: str = "monthly"  # çµå¸³é€±æœŸ: monthly(æœˆçµ), quarterly(å­£çµ)
    note: str = ""  # å‚™è¨»
    id: str = field(default_factory=lambda: str(uuid4()))
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    updated_at: str = field(default_factory=lambda: datetime.now().isoformat())

# å•†å“è³‡æ–™æ¨¡å‹
@dataclass
class Product:
    name: str  # å•†å“åç¨±
    category: str = ""  # å•†å“åˆ†é¡
    cost_price: float = 0.0  # æˆæœ¬åƒ¹
    selling_price: float = 0.0  # å»ºè­°å”®åƒ¹
    stock: int = 0  # åº«å­˜æ•¸é‡
    id: str = field(default_factory=lambda: str(uuid4()))
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    updated_at: str = field(default_factory=lambda: datetime.now().isoformat())

# é€²è²¨è¨˜éŒ„æ¨¡å‹
@dataclass
class Purchase:
    supplier_id: str  # ä¾›æ‡‰å•†ID
    id: str = field(default_factory=lambda: str(uuid4()))
    purchase_date: str = field(default_factory=lambda: date.today().isoformat())
    total_amount: float = 0.0  # ç¸½é‡‘é¡
    paid: bool = False  # æ˜¯å¦å·²ä»˜æ¬¾
    paid_date: Optional[str] = None  # ä»˜æ¬¾æ—¥æœŸ
    note: str = ""  # å‚™è¨»
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    
    # æ˜ç´°é …ç›® (ä¸æœƒç›´æ¥å„²å­˜ï¼Œè€Œæ˜¯é€šéPurchaseItemé—œè¯)
    items: List[Dict] = field(default_factory=list)

# é€²è²¨æ˜ç´°é …ç›®
@dataclass
class PurchaseItem:
    purchase_id: str  # é€²è²¨å–®ID
    product_id: str  # å•†å“ID
    quantity: int  # æ•¸é‡
    unit_price: float  # å–®åƒ¹
    total_price: float  # ç¸½åƒ¹ (quantity * unit_price)

# æœƒå“¡è³‡æ–™æ¨¡å‹
@dataclass
class Member:
    name: str  # æœƒå“¡å§“å
    phone: str = ""  # é›»è©±
    email: str = ""  # é›»å­éƒµä»¶
    note: str = ""  # å‚™è¨»
    id: str = field(default_factory=lambda: str(uuid4()))
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    updated_at: str = field(default_factory=lambda: datetime.now().isoformat())
    
# ä»˜æ¬¾ç´€éŒ„æ¨¡å‹
@dataclass
class Payment:
    supplier_id: str  # ä¾›æ‡‰å•†ID
    amount: float     # ä»˜æ¬¾é‡‘é¡
    payment_date: str # ä»˜æ¬¾æ—¥æœŸ
    id: str = field(default_factory=lambda: str(uuid4()))
    note: str = ""    # å‚™è¨»
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    # é—œè¯çš„é€²è²¨å–®IDåˆ—è¡¨ (éå¿…è¦ï¼Œä½†æœ‰åŠ©æ–¼è¿½è¹¤)
    purchase_ids: List[str] = field(default_factory=list)   


# éŠ·å”®è¨˜éŒ„æ¨¡å‹
@dataclass
class Sale:
    id: str = field(default_factory=lambda: str(uuid4()))
    member_id: Optional[str] = None  # æœƒå“¡ID (å¯é¸)
    sale_date: str = field(default_factory=lambda: datetime.now().isoformat())
    total_amount: float = 0.0  # ç¸½é‡‘é¡
    discount_amount: float = 0.0  # æŠ˜æ‰£é‡‘é¡
    final_amount: float = 0.0  # å¯¦éš›æ”¶æ¬¾é‡‘é¡ (total_amount - discount_amount)
    payment_method: str = "cash"  # ä»˜æ¬¾æ–¹å¼: cash, credit_card, etc.
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    
    # æ˜ç´°é …ç›® (ä¸æœƒç›´æ¥å„²å­˜ï¼Œè€Œæ˜¯é€šéSaleItemé—œè¯)
    items: List[Dict] = field(default_factory=list)

# éŠ·å”®æ˜ç´°é …ç›®
@dataclass
class SaleItem:
    sale_id: str  # éŠ·å”®å–®ID
    product_id: str  # å•†å“ID
    quantity: int  # æ•¸é‡
    unit_price: float  # å–®åƒ¹
    total_price: float  # ç¸½åƒ¹ (quantity * unit_price - discount)
    discount: float = 0.0  # æŠ˜æ‰£é‡‘é¡

# æŠ˜æ‰£æ´»å‹•æ¨¡å‹
@dataclass
class Discount:
    # --- æ²’æœ‰é è¨­å€¼çš„æ¬„ä½æ”¾å‰é¢ ---
    name: str  # æ´»å‹•åç¨±
    value: float  # æŠ˜æ‰£å€¼ (ç™¾åˆ†æ¯”: 0-100, å›ºå®šé‡‘é¡: æŠ˜æ‰£é‡‘é¡)
    valid_from: str  # æ´»å‹•é–‹å§‹æ—¥æœŸ
    valid_to: str  # æ´»å‹•çµæŸæ—¥æœŸ

    # --- æœ‰é è¨­å€¼çš„æ¬„ä½æ”¾å¾Œé¢ ---
    id: str = field(default_factory=lambda: str(uuid4()))
    discount_type: Literal["percentage", "fixed"] = "percentage"  # æŠ˜æ‰£é¡å‹: ç™¾åˆ†æ¯”/å›ºå®šé‡‘é¡
    target_type: Literal["product", "category", "all"] = "product"  # é©ç”¨å°è±¡
    target_id: Optional[str] = None  # å°è±¡ID (å•†å“IDæˆ–åˆ†é¡åç¨±)
    created_at: str = field(default_factory=lambda: datetime.now().isoformat())
    updated_at: str = field(default_factory=lambda: datetime.now().isoformat())

# è³‡æ–™åº«é›†åˆåç¨±
COLLECTIONS = {
    'suppliers': 'suppliers',
    'products': 'products',
    'purchases': 'purchases',
    'purchase_items': 'purchase_items',
    'payments': 'payments', 
    'members': 'members',
    'sales': 'sales',
    'sale_items': 'sale_items',
    'discounts': 'discounts'
}


===== PROGRESS_LOG.md =====
# Development Log

This log captures progress on resolving data issues and implementing features.

## 2025-07-30
- Normalized `members.json` and `sales.json` to use array structures only.
- Enhanced `load_data` in `main.py` to support legacy wrapped formats.
- Created `TODO.md` with pending tasks for future improvements.

## 2025-07-31
- Added `validate_required_fields` helper and integrated basic validation into API endpoints.
- Refactored `BaseService` to transparently handle list-based JSON files.
- Created `init_data.py` script for initializing empty data files.
- Added unit tests for validation and service helpers.

## 2025-08-01
- Added optional stubs for FastAPI and uvicorn so tests run without network dependencies.
- Cleaned up stray `__pycache__` directories from the repository.




===== requirements.txt =====
fastapi==0.104.1
uvicorn==0.24.0
python-multipart==0.0.6
python-dateutil==2.8.2
pydantic==2.4.2
pytest==8.4.1


===== TODO.md =====
# TODO List

This document tracks outstanding tasks for the project and records progress on resolving them.

## Pending tasks


- [ ] Create unit tests.


## Completed tasks

- [x] Unified `members.json` and `sales.json` to simple array structures.
- [x] Updated `load_data` helper to handle legacy wrapped formats gracefully.
- [x] Implement payment record API endpoints and link purchases with payments.
- [x] Provide CRUD for discount objects and integrate with sale calculations.
- [x] Update member statistics when sales are created.
- [x] Improve delete operations to check for related records (e.g. suppliers with payments).
- [x] Added optional FastAPI/uvicorn stubs for offline testing.
- [x] Add data validation helpers and better error handling.
- [x] Write initialization script.
- [x] Review `BaseService` data model mismatch (dictionary vs list) and refactor if needed.
- [x] `templates/sales.html`: Added missing elements required by `sales.js`.
- [x] `static/js/purchases.js`: Implemented create and delete functionality.
- [x] `static/js/reports.js`: Fetched sales and category data from API and redrew charts.
- [x] `static/js/members.js`: Confirmed member create/edit/delete actions are API-connected.
- [x] `static/js/suppliers.js`: Confirmed supplier management actions are API-connected.
- [x] `static/js/products.js`: Implemented product image upload and barcode scanning.

===== utils.py =====
from typing import Dict, List, Optional


def validate_required_fields(data: Dict, required: List[str]) -> Optional[str]:
    """Return error message if any required field is missing or empty."""
    missing = [field for field in required if not data.get(field)]
    if missing:
        return "ç¼ºå°‘å¿…è¦æ¬„ä½: " + ", ".join(missing)
    return None


===== æ›¸æˆ¿è¨˜å¸³èˆ‡ç‡Ÿé‹ç®¡ç†ç³»çµ± è¦æ ¼æ›¸.md =====
# æ›¸æˆ¿è¨˜å¸³èˆ‡ç‡Ÿé‹ç®¡ç†ç³»çµ± è¦æ ¼æ›¸

ä¸€ã€ç³»çµ±ç›®æ¨™èˆ‡æ ¸å¿ƒæ¦‚å¿µ

æ­¤ç³»çµ±æ—¨åœ¨å”åŠ©ç¦éŸ³æ›¸æˆ¿é€²è¡Œé€²éŠ·å­˜è¨˜éŒ„ã€ä¾›æ‡‰å•†çµå¸³ç®¡ç†ã€æœƒå“¡éŠ·å”®è¨˜éŒ„èˆ‡æŠ˜æ‰£è¿½è¹¤ï¼Œæå‡ç‡Ÿé‹é€æ˜åº¦èˆ‡è³‡æ–™ä¿å­˜å®Œæ•´æ€§ã€‚ç›®æ¨™ç‚ºæä¾›ä¸€å¥—ç°¡ä¾¿ã€å®‰å…¨ã€å¯æ‰‹æ©Ÿæ“ä½œçš„é›¢ç·šç®¡ç†å·¥å…·ï¼Œå…¼é¡§æ—¥å¸¸è¨˜å¸³èˆ‡å°å¸³éœ€æ±‚ã€‚

äºŒã€ç³»çµ±æ¨¡çµ„æ¶æ§‹

1. å•†å“èˆ‡é€²è²¨ç®¡ç†

å•†å“å»ºç«‹èˆ‡åˆ†é¡

é€²è²¨ç™»éŒ„ï¼šå«ä¾›æ‡‰å•†ã€æ•¸é‡ã€å–®åƒ¹ã€ç¸½é‡‘é¡ã€è‡ªå‹•è¨ˆç®—æˆæœ¬

å¯æ¨™è¨»æ˜¯å¦å·²ä»˜æ¬¾ã€ä»˜æ¬¾æ—¥ã€å‚™è¨»

2. ä¾›æ‡‰å•†èˆ‡çµå¸³ç®¡ç†

ä¾›æ‡‰å•†åŸºæœ¬è³‡è¨Šè¨­å®šï¼ˆçµå¸³é€±æœŸã€è‡ªè¨‚è¯çµ¡è³‡æ–™ï¼‰

æ¯æœˆï¼æ¯å­£çµå¸³é€±æœŸè¨­å®š

æ”¯æ´å¤šç­†é€²è²¨æ‰¹æ¬¡çµå¸³èˆ‡éƒ¨åˆ†ä»˜æ¬¾

æ‡‰ä»˜æ¬¾çµ±è¨ˆèˆ‡ä»˜æ¬¾è¨˜éŒ„ç®¡ç†

3. éŠ·å”®èˆ‡æŠ˜æ‰£ç®¡ç†

å•†å“éŠ·å”®è¼¸å…¥ï¼šé¸æ“‡å•†å“ã€æ•¸é‡ã€å¯¦éš›å”®åƒ¹æˆ–æŠ˜æ‰£é‡‘é¡ï¼ç™¾åˆ†æ¯”

å¯é—œè¯æœƒå“¡è³‡è¨Š

è‡ªå‹•è¨ˆç®—ç¸½é‡‘é¡ã€æ‰¾é›¶

éŠ·å”®æ˜ç´°ï¼ˆå«å•†å“ã€å”®åƒ¹ã€æŠ˜æ‰£ã€æ•¸é‡ï¼‰ç¨ç«‹è¨˜éŒ„

æŠ˜æ‰£å¯æ‰‹å‹•æˆ–å¾é è¨­æ´»å‹•å¥—ç”¨

4. æœƒå“¡ç®¡ç†

å»ºç«‹åŸºæœ¬è³‡æ–™ï¼ˆå§“åã€é›»è©±ã€å‚™è¨»ï¼‰

é—œè¯éŠ·å”®è¨˜éŒ„

æŸ¥è©¢æœƒå“¡è³¼è²·æ­·å²ã€ç´¯è¨ˆé‡‘é¡èˆ‡æœ€å¾Œäº¤æ˜“æ—¥

5. æŸ¥è©¢èˆ‡å ±è¡¨

é€²è²¨æŸ¥è©¢ï¼ˆå¯ä¾ä¾›æ‡‰å•†ã€æ—¥æœŸã€ä»˜æ¬¾ç‹€æ…‹ï¼‰

éŠ·å”®æŸ¥è©¢ï¼ˆæ¯æ—¥ï¼æœŸé–“ç¸½é¡ã€æŠ˜æ‰£çµ±è¨ˆï¼‰

æœƒå“¡æŸ¥è©¢ï¼ˆä¾æœƒå“¡æŸ¥éŠ·å”®ç´€éŒ„ï¼‰

ä¾›æ‡‰å•†çµå¸³å ±è¡¨ï¼ˆæ‡‰ä»˜ï¼å·²ä»˜ç¸½é¡ã€è‡ªå‹•çµå¸³å»ºè­°ï¼‰

ä¸‰ã€è³‡æ–™åº«çµæ§‹å»ºè­°ï¼ˆè¡¨æ ¼è¨­è¨ˆï¼‰

1. suppliersï¼ˆä¾›æ‡‰å•†ï¼‰

æ¬„ä½åç¨±é¡å‹èªªæ˜idintä¸»éµnametextä¾›æ‡‰å•†åç¨±contacttextè¯çµ¡æ–¹å¼payment_cycletextçµå¸³é€±æœŸï¼ˆä¾‹å¦‚ï¼šæœˆçµã€å­£çµï¼‰notetextå‚™è¨»2. productsï¼ˆå•†å“ï¼‰

| id | int | ä¸»éµ |

| name | text | å•†å“åç¨± |

| category | text | å•†å“åˆ†é¡ |

| cost_price | float | æˆæœ¬åƒ¹ |

| selling_price | float | å»ºè­°å”®åƒ¹ |

3. purchasesï¼ˆé€²è²¨ç´€éŒ„ï¼‰

| id | int | ä¸»éµ |

| supplier_id | int | å¤–éµï¼šä¾›æ‡‰å•† |

| product_id | int | å¤–éµï¼šå•†å“ |

| quantity | int | æ•¸é‡ |

| unit_price | float | å–®åƒ¹ |

| total_price | float | è‡ªå‹•è¨ˆç®—ç¸½åƒ¹ |

| purchase_date | date | é€²è²¨æ—¥æœŸ |

| paid | boolean | æ˜¯å¦å·²ä»˜æ¬¾ |

| paid_date | date | ä»˜æ¬¾æ—¥æœŸï¼ˆè‹¥å·²ä»˜æ¬¾ï¼‰ |

| note | text | å‚™è¨» |

4. paymentsï¼ˆä»˜æ¬¾ç´€éŒ„ï¼‰

| id | int | ä¸»éµ |

| supplier_id | int | å¤–éµï¼šä¾›æ‡‰å•† |

| amount | float | ä»˜æ¬¾é‡‘é¡ |

| payment_date | date | ä»˜æ¬¾æ—¥æœŸ |

| note | text | å‚™è¨» |

5. membersï¼ˆæœƒå“¡ï¼‰

| id | int | ä¸»éµ |

| name | text | æœƒå“¡å§“å |

| phone | text | è¯çµ¡é›»è©± |

| note | text | å‚™è¨» |

6. salesï¼ˆéŠ·å”®ä¸»æª”ï¼‰

| id | int | ä¸»éµ |

| member_id | int/null | å¤–éµï¼šæœƒå“¡ï¼ˆå¯ç©ºï¼‰ |

| sale_date | date | éŠ·å”®æ—¥æœŸ |

| total_amount | float | éŠ·å”®ç¸½é¡ |

| cash_received | float | å¯¦æ”¶é‡‘é¡ |

| change_given | float | æ‰¾é›¶é‡‘é¡ |

| note | text | å‚™è¨» |

| items | array | éŠ·å”®æ˜ç´° JSON é™£åˆ—ï¼ˆå¯åµŒå¥—æ¯ç­†å•†å“è³‡è¨Šï¼‰ |

7. sales_itemsï¼ˆéŠ·å”®æ˜ç´°ï¼‰

è‹¥æ¡ç”¨åµŒå¥—æ–¼ sales å…§éƒ¨ï¼Œå¯ç•¥éæ­¤è¡¨

| id | int | ä¸»éµ |

| sale_id | int | å¤–éµï¼šéŠ·å”®å–®è™Ÿ |

| product_id | int | å¤–éµï¼šå•†å“ |

| quantity | int | æ•¸é‡ |

| price | float | å–®åƒ¹ï¼ˆå«æŠ˜æ‰£å¾Œï¼‰ |

| discount | float | æŠ˜æ‰£ï¼ˆè‹¥æœ‰ï¼‰ |

8. discountsï¼ˆå¯é¸ï¼Œé è¨­æŠ˜æ‰£ï¼‰

| id | int | ä¸»éµ |

| product_id | int | å¤–éµï¼šå•†å“ |

| discount_type | text | percent / fixed |

| value | float | æŠ˜æ‰£æ•¸å€¼ï¼ˆ10% æˆ–å›ºå®šé‡‘é¡ï¼‰ |

| valid_from | date | æ´»å‹•èµ·å§‹æ—¥ |

| valid_to | date | æ´»å‹•çµæŸæ—¥ |

å››ã€ç³»çµ±æŠ€è¡“å»ºè­°ï¼ˆä»¥ Firebase ç‚ºåŸºç¤ï¼‰

ä½¿ç”¨ Firebase Firestore ä½œç‚ºä¸»è³‡æ–™åº«ï¼ˆJSON çµæ§‹æ–‡ä»¶ï¼‰

Firebase Authentication è™•ç†ç™»å…¥é©—è­‰ï¼ˆEmail/å¯†ç¢¼ æˆ– Google ç™»å…¥ï¼‰

Firebase Hosting éƒ¨ç½² Web æ“ä½œä»‹é¢

æ”¯æ´æ‰‹æ©Ÿèˆ‡æ¡Œæ©Ÿä»‹é¢

è‹¥æœ‰é€²éšéœ€æ±‚ï¼Œå¯åŠ å…¥ Cloud Functions è™•ç†å®šæ™‚çµå¸³æé†’ã€è‡ªå‹•çµ±è¨ˆèˆ‡å‚™ä»½

äº”ã€Firestore å»ºè­°è³‡æ–™çµæ§‹

/suppliers/{supplierId}

/products/{productId}

/purchases/{purchaseId}

/payments/{paymentId}

/members/{memberId}

/sales/{saleId}

/sales/{saleId}/items/{itemId}ï¼ˆè‹¥ä½¿ç”¨å­é›†åˆï¼‰

/discounts/{discountId}

æ¯å€‹ Document çš†ç‚º JSON æ ¼å¼ï¼Œä¸¦ä¾ç…§å„æ¨¡çµ„è³‡æ–™è¨­è¨ˆå¡«å…¥å°æ‡‰æ¬„ä½ã€‚

å…­ã€æ“´å……æ–¹å‘å»ºè­°

å•†å“åº«å­˜æ•¸é‡ç®¡ç†ï¼ˆæ¯æ¬¡é€²è²¨ï¼‹éŠ·å”®è‡ªå‹•èª¿æ•´ï¼‰

æœˆçµè‡ªå‹•æé†’èˆ‡ä¾›æ‡‰å•†çµæ¸…å»ºè­°é‡‘é¡

åœ–è¡¨å„€è¡¨æ¿ï¼ˆç¸½é«”ç‡Ÿæ”¶ã€ä»˜æ¬¾é€²åº¦ã€æœƒå“¡æ’è¡Œæ¦œï¼‰

å®¢è£½åŒ– Excel åŒ¯å‡ºæ ¼å¼ï¼ˆå ±å¸³èˆ‡çµå¸³ç”¨ï¼‰


===== .vscode\settings.json =====
{
    "liveServer.settings.port": 5501
}

===== data\discounts.json =====
[
  {
    "id": "D001",
    "name": "å…¨é¤¨ 10% off",
    "target_type": "all",
    "target_id": null,
    "discount_type": "percentage",
    "value": 10,
    "valid_from": "2025-08-01T00:00:00",
    "valid_to": "2025-08-31T23:59:59"
  }
]


===== data\members.json =====
[
  {
    "id": "M001",
    "name": "ç‹å°æ˜",
    "phone": "0912345678",
    "email": "ming@example.com",
    "address": "å°åŒ—å¸‚å¤§å®‰å€å¾©èˆˆå—è·¯ä¸€æ®µ100è™Ÿ",
    "birthday": "1990-05-15",
    "join_date": "2025-01-10T10:00:00Z",
    "total_purchases": 5,
    "total_spent": 4620.0,
    "last_visit": "2025-07-20T10:15:00Z",
    "notes": "å¸¸è³¼è²·éˆä¿®é¡æ›¸ç±",
    "created_at": "2025-01-10T10:00:00Z",
    "updated_at": "2025-08-06T15:09:58.942926",
    "points": 11
  },
  {
    "id": "M002",
    "name": "æ—å°è¯",
    "phone": "0922333444",
    "email": "hua@example.com",
    "address": "æ–°åŒ—å¸‚æ¿æ©‹å€æ–‡åŒ–è·¯ä¸€æ®µ200è™Ÿ",
    "birthday": "1985-10-20",
    "join_date": "2025-02-15T14:30:00Z",
    "total_purchases": 3,
    "total_spent": 2800,
    "last_visit": "2025-07-18T16:45:00Z",
    "notes": "åå¥½ç¥å­¸é¡æ›¸ç±",
    "created_at": "2025-02-15T14:30:00Z",
    "updated_at": "2025-07-31T13:32:37.356793",
    "member_level": "standard",
    "status": "active"
  },
  {
    "id": "M003",
    "name": "é™³å°ç¾",
    "phone": "0933555777",
    "email": "mei@example.com",
    "address": "å°åŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ50è™Ÿ",
    "birthday": "1995-03-25",
    "join_date": "2025-03-05T11:20:00Z",
    "total_purchases": 2,
    "total_spent": 1500,
    "last_visit": "2025-07-10T13:15:00Z",
    "notes": "æ–°æœƒå“¡ï¼Œè³¼è²·å…’ç«¥è–ç¶“",
    "created_at": "2025-03-05T11:20:00Z",
    "updated_at": "2025-07-10T13:15:00Z"
  },
  {
    "id": "M0002",
    "name": "JJ",
    "phone": "0909090990",
    "email": "123@GG",
    "birthday": "2025-07-24",
    "member_level": "platinum",
    "status": "active",
    "address": "123",
    "notes": "456",
    "total_spent": 1605.0,
    "points": 15,
    "created_at": "2025-07-24T17:48:11.616828",
    "updated_at": "2025-08-06T16:10:12.664988"
  }
]

===== data\payments.json =====
[]

===== data\products.json =====
[
  {
    "id": "P001",
    "name": "åŸå­ç¿’æ…£",
    "category": "æ›¸ç±",
    "purchase_price": 280,
    "sale_price": 500,
    "stock": 50,
    "supplier_id": "S001",
    "min_stock": 5,
    "unit": "æœ¬",
    "created_at": "2025-07-01T10:00:00+08:00",
    "updated_at": "2025-08-06T14:22:49.245120",
    "description": ""
  },
  {
    "id": "P002",
    "name": "è¢«è¨å­çš„å‹‡æ°£",
    "category": "å¿ƒç†å‹µå¿—",
    "purchase_price": 220,
    "sale_price": 280,
    "stock": 20,
    "supplier_id": "S001",
    "min_stock": 5,
    "unit": "æœ¬",
    "created_at": "2025-07-01T10:00:00+08:00",
    "updated_at": "2025-08-06T15:09:58.942926"
  },
  {
    "id": "P101",
    "name": "ç­†è¨˜æœ¬",
    "category": "æ–‡å…·",
    "purchase_price": 15,
    "sale_price": 25,
    "stock": 93,
    "supplier_id": "S002",
    "min_stock": 20,
    "unit": "æœ¬",
    "created_at": "2025-07-15T09:30:00+08:00",
    "updated_at": "2025-08-06T17:08:20.270438"
  },
  {
    "id": "P102",
    "name": "åŸå­ç­†",
    "category": "æ–‡å…·",
    "purchase_price": 8,
    "sale_price": 15,
    "stock": 193,
    "supplier_id": "S002",
    "min_stock": 50,
    "unit": "æ”¯",
    "created_at": "2025-07-15T09:30:00+08:00",
    "updated_at": "2025-08-06T17:08:20.270438"
  },
  {
    "id": "P201",
    "name": "é«˜ç´šé‹¼ç­†",
    "category": "æ–‡å…·",
    "purchase_price": 900,
    "sale_price": 1200,
    "stock": 15,
    "supplier_id": "S003",
    "min_stock": 5,
    "unit": "æ”¯",
    "created_at": "2025-07-20T11:00:00+08:00",
    "updated_at": "2025-07-23T09:15:00+08:00"
  },
  {
    "id": "P301",
    "name": "é«˜ç´šæ›¸æ¶",
    "category": "å‚¢ä¿±",
    "purchase_price": 2000,
    "sale_price": 2500,
    "stock": 5,
    "supplier_id": "S004",
    "min_stock": 2,
    "unit": "çµ„",
    "created_at": "2025-07-18T14:00:00+08:00",
    "updated_at": "2025-07-22T16:45:00+08:00"
  },
  {
    "id": "P401",
    "name": "æš¢éŠ·å°èªª",
    "category": "å°èªª",
    "purchase_price": 140,
    "sale_price": 180,
    "stock": 44,
    "supplier_id": "S005",
    "min_stock": 10,
    "unit": "æœ¬",
    "created_at": "2025-07-15T10:00:00+08:00",
    "updated_at": "2025-08-06T16:10:12.664988"
  },
  {
    "id": "P402",
    "name": "å•†æ¥­ç†è²¡æ›¸",
    "category": "å•†æ¥­",
    "purchase_price": 180,
    "sale_price": 220,
    "stock": 26,
    "supplier_id": "S005",
    "min_stock": 10,
    "unit": "æœ¬",
    "created_at": "2025-07-15T10:00:00+08:00",
    "updated_at": "2025-08-06T17:07:26.488118"
  },
  {
    "id": "P403",
    "name": "å…’ç«¥ç¹ªæœ¬",
    "category": "å…’ç«¥",
    "purchase_price": 120,
    "sale_price": 150,
    "stock": 40,
    "supplier_id": "S005",
    "min_stock": 10,
    "unit": "æœ¬",
    "created_at": "2025-07-15T10:00:00+08:00",
    "updated_at": "2025-07-22T10:30:00+08:00"
  }
]

===== data\purchases.json =====
[
  {
    "id": "1",
    "purchase_number": "PO-20250724-0001",
    "supplier_id": "S001",
    "purchase_date": "2025-07-24T10:00:00+08:00",
    "expected_delivery_date": "2025-07-31T23:59:59+08:00",
    "status": "received",
    "shipping_fee": 150,
    "tax_rate": 5,
    "notes": "ä¸€èˆ¬åœ–æ›¸é€²è²¨",
    "items": [
      {
        "product_id": "P001",
        "quantity": 20,
        "unit_price": 350,
        "product_name": "åŸå­ç¿’æ…£"
      },
      {
        "product_id": "P002",
        "quantity": 15,
        "unit_price": 280,
        "product_name": "è¢«è¨å­çš„å‹‡æ°£"
      }
    ],
    "total": 11250,
    "created_at": "2025-07-24T10:00:00+08:00",
    "updated_at": "2025-07-24T10:00:00+08:00"
  },
  {
    "id": "2",
    "purchase_number": "PO-20250724-0002",
    "supplier_id": "S002",
    "purchase_date": "2025-07-24T14:30:00+08:00",
    "expected_delivery_date": "2025-07-28T23:59:59+08:00",
    "status": "ordered",
    "shipping_fee": 100,
    "tax_rate": 5,
    "notes": "æ–‡å…·ç”¨å“é€²è²¨",
    "items": [
      {
        "product_id": "P101",
        "quantity": 50,
        "unit_price": 25,
        "product_name": "ç­†è¨˜æœ¬"
      },
      {
        "product_id": "P102",
        "quantity": 100,
        "unit_price": 15,
        "product_name": "åŸå­ç­†"
      }
    ],
    "total": 2875,
    "created_at": "2025-07-24T14:30:00+08:00",
    "updated_at": "2025-07-24T14:30:00+08:00"
  },
  {
    "id": "3",
    "purchase_number": "PO-20250723-0001",
    "supplier_id": "S003",
    "purchase_date": "2025-07-23T09:15:00+08:00",
    "expected_delivery_date": "2025-07-30T23:59:59+08:00",
    "status": "draft",
    "shipping_fee": 0,
    "tax_rate": 0,
    "notes": "è‰ç¨¿è¨‚å–®",
    "items": [
      {
        "product_id": "P201",
        "quantity": 10,
        "unit_price": 1200,
        "product_name": "é«˜ç´šé‹¼ç­†"
      }
    ],
    "total": 12000,
    "created_at": "2025-07-23T09:15:00+08:00",
    "updated_at": "2025-07-23T09:15:00+08:00"
  },
  {
    "id": "4",
    "purchase_number": "PO-20250722-0001",
    "supplier_id": "S004",
    "purchase_date": "2025-07-22T11:20:00+08:00",
    "expected_delivery_date": "2025-07-29T23:59:59+08:00",
    "status": "cancelled",
    "shipping_fee": 200,
    "tax_rate": 5,
    "notes": "ä¾›æ‡‰å•†ç¼ºè²¨å–æ¶ˆ",
    "items": [
      {
        "product_id": "P301",
        "quantity": 5,
        "unit_price": 2500,
        "product_name": "é«˜ç´šæ›¸æ¶"
      }
    ],
    "total": 12750,
    "created_at": "2025-07-22T11:20:00+08:00",
    "updated_at": "2025-07-22T16:45:00+08:00"
  },
  {
    "id": "5",
    "purchase_number": "PO-20250721-0001",
    "supplier_id": "S005",
    "purchase_date": "2025-07-21T15:10:00+08:00",
    "expected_delivery_date": "2025-07-25T23:59:59+08:00",
    "status": "received",
    "shipping_fee": 180,
    "tax_rate": 5,
    "notes": "ä¿ƒéŠ·æ´»å‹•ç”¨æ›¸",
    "items": [
      {
        "product_id": "P401",
        "quantity": 30,
        "unit_price": 180,
        "product_name": "æš¢éŠ·å°èªª"
      },
      {
        "product_id": "P402",
        "quantity": 20,
        "unit_price": 220,
        "product_name": "å•†æ¥­ç†è²¡æ›¸"
      },
      {
        "product_id": "P403",
        "quantity": 15,
        "unit_price": 150,
        "product_name": "å…’ç«¥ç¹ªæœ¬"
      }
    ],
    "total": 11550,
    "created_at": "2025-07-21T15:10:00+08:00",
    "updated_at": "2025-07-22T10:30:00+08:00"
  },
  {
    "id": "P0006",
    "purchase_number": "PO-20250724-0006",
    "supplier_id": "S001",
    "purchase_date": "2025-07-24",
    "expected_delivery_date": "",
    "status": "ordered",
    "shipping_fee": 5000.0,
    "tax_rate": 0.0,
    "notes": "",
    "items": [
      {
        "product_id": "P401",
        "quantity": 1,
        "unit_price": 140.0,
        "product_name": "æš¢éŠ·å°èªª"
      },
      {
        "product_id": "P301",
        "quantity": 1,
        "unit_price": 2000.0,
        "product_name": "é«˜ç´šæ›¸æ¶"
      }
    ],
    "subtotal": 2140.0,
    "tax": 0.0,
    "total_amount": 7140.0,
    "payment_status": "paid",
    "created_at": "2025-07-24T17:54:01.365745",
    "updated_at": "2025-07-24T17:54:01.365745",
    "created_by": "system"
  },
  {
    "id": "P0007",
    "purchase_number": "PO-20250724-0007",
    "supplier_id": "S004",
    "purchase_date": "2025-07-24",
    "expected_delivery_date": "2025-07-24",
    "status": "ordered",
    "shipping_fee": 0.0,
    "tax_rate": 0.0,
    "notes": "",
    "items": [
      {
        "product_id": "P301",
        "quantity": 2,
        "unit_price": 2000.0,
        "product_name": "é«˜ç´šæ›¸æ¶"
      }
    ],
    "subtotal": 4000.0,
    "tax": 0.0,
    "total_amount": 4000.0,
    "payment_status": "unpaid",
    "created_at": "2025-07-24T17:54:39.494246",
    "updated_at": "2025-07-24T17:54:39.494246",
    "created_by": "system"
  }
]

===== data\sales.json =====
[
  {
    "id": "S001",
    "customer_id": "M001",
    "sale_date": "2025-07-20T10:15:00Z",
    "subtotal": 550,
    "discount": 50,
    "total_amount": 500,
    "payment_method": "ç¾é‡‘",
    "items": [
      {
        "product_id": "P001",
        "quantity": 1,
        "unit_price": 300,
        "discount": 0,
        "subtotal": 300
      },
      {
        "product_id": "P002",
        "quantity": 1,
        "unit_price": 250,
        "discount": 50,
        "subtotal": 200
      }
    ],
    "notes": "æœƒå“¡æ¶ˆè²»",
    "created_at": "2025-07-20T10:15:00Z"
  },
  {
    "id": "S002",
    "customer_id": null,
    "sale_date": "2025-07-21T15:30:00Z",
    "subtotal": 900,
    "discount": 0,
    "total_amount": 900,
    "payment_method": "ä¿¡ç”¨å¡",
    "items": [
      {
        "product_id": "P003",
        "quantity": 2,
        "unit_price": 450,
        "discount": 0,
        "subtotal": 900
      }
    ],
    "notes": "éæœƒå“¡æ¶ˆè²»",
    "created_at": "2025-07-21T15:30:00Z"
  },
  {
    "id": "S20250806142429",
    "items": [
      {
        "product_id": "P102",
        "quantity": 1,
        "unit_price": 15
      },
      {
        "product_id": "P002",
        "quantity": 1,
        "unit_price": 280
      },
      {
        "product_id": "P101",
        "quantity": 1,
        "unit_price": 25
      }
    ],
    "member_id": null,
    "subtotal": 320.0,
    "discount": 0.0,
    "total": 320.0,
    "payment_method": "cash",
    "amount_received": 500.0,
    "change": 180.0,
    "created_at": "2025-08-06T14:24:29.132665",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806150921",
    "items": [
      {
        "product_id": "P102",
        "quantity": 1,
        "unit_price": 15
      }
    ],
    "member_id": null,
    "subtotal": 15.0,
    "discount": 0.0,
    "total": 15.0,
    "payment_method": "cash",
    "amount_received": 100.0,
    "change": 85.0,
    "created_at": "2025-08-06T15:09:21.702525",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806150958",
    "items": [
      {
        "product_id": "P002",
        "quantity": 4,
        "unit_price": 280
      }
    ],
    "member_id": "M001",
    "subtotal": 1120.0,
    "discount": 0.0,
    "total": 1120.0,
    "payment_method": "cash",
    "amount_received": 1500.0,
    "change": 380.0,
    "created_at": "2025-08-06T15:09:58.942926",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806151150",
    "items": [
      {
        "product_id": "P101",
        "quantity": 4,
        "unit_price": 25
      }
    ],
    "member_id": null,
    "subtotal": 100.0,
    "discount": 0.0,
    "total": 100.0,
    "payment_method": "cash",
    "amount_received": 1000.0,
    "change": 900.0,
    "created_at": "2025-08-06T15:11:50.046670",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806151607",
    "items": [
      {
        "product_id": "P102",
        "quantity": 3,
        "unit_price": 15
      }
    ],
    "member_id": "M0002",
    "subtotal": 45.0,
    "discount": 0.0,
    "total": 45.0,
    "payment_method": "cash",
    "amount_received": 45.0,
    "change": 0.0,
    "created_at": "2025-08-06T15:16:07.587659",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806151744",
    "items": [
      {
        "product_id": "P102",
        "quantity": 1,
        "unit_price": 15
      },
      {
        "product_id": "P402",
        "quantity": 2,
        "unit_price": 220
      },
      {
        "product_id": "P401",
        "quantity": 1,
        "unit_price": 180
      },
      {
        "product_id": "P101",
        "quantity": 1,
        "unit_price": 25
      }
    ],
    "member_id": "M0002",
    "subtotal": 660.0,
    "discount": 0.0,
    "total": 660.0,
    "payment_method": "cash",
    "amount_received": 660.0,
    "change": 0.0,
    "created_at": "2025-08-06T15:17:44.527822",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806161012",
    "items": [
      {
        "product_id": "P401",
        "quantity": 5,
        "unit_price": 180
      }
    ],
    "member_id": "M0002",
    "subtotal": 900.0,
    "discount": 0.0,
    "total": 900.0,
    "payment_method": "cash",
    "amount_received": 1000.0,
    "change": 100.0,
    "manual_discount_type": null,
    "manual_discount_value": 0.0,
    "created_at": "2025-08-06T16:10:12.664988",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806161208",
    "items": [
      {
        "product_id": "P402",
        "quantity": 1,
        "unit_price": 220
      }
    ],
    "member_id": null,
    "subtotal": 220.0,
    "discount": 0.0,
    "total": 220.0,
    "payment_method": "line_pay",
    "amount_received": 500.0,
    "change": 280.0,
    "manual_discount_type": null,
    "manual_discount_value": 0.0,
    "created_at": "2025-08-06T16:12:08.956724",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806170726",
    "items": [
      {
        "product_id": "P402",
        "quantity": 1,
        "unit_price": 220
      }
    ],
    "member_id": null,
    "subtotal": 220.0,
    "discount": 0.0,
    "total": 220.0,
    "payment_method": "cash",
    "amount_received": 300.0,
    "change": 80.0,
    "manual_discount_type": null,
    "manual_discount_value": 0.0,
    "created_at": "2025-08-06T17:07:26.488118",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  },
  {
    "id": "S20250806170820",
    "items": [
      {
        "product_id": "P102",
        "quantity": 1,
        "unit_price": 15
      },
      {
        "product_id": "P101",
        "quantity": 1,
        "unit_price": 25
      }
    ],
    "member_id": null,
    "subtotal": 40.0,
    "discount": 0.0,
    "total": 40.0,
    "payment_method": "cash",
    "amount_received": 50.0,
    "change": 10.0,
    "manual_discount_type": null,
    "manual_discount_value": 0.0,
    "created_at": "2025-08-06T17:08:20.270438",
    "cashier": "ç³»çµ±ç®¡ç†å“¡"
  }
]

===== data\suppliers.json =====
[
  {
    "id": "S001",
    "name": "å¤©ä¸‹æ–‡åŒ–",
    "contact_person": "ç‹ç¶“ç†",
    "phone": "02-2517-3688",
    "email": "service@bookzone.com.tw",
    "address": "å°åŒ—å¸‚æ¾æ±Ÿè·¯209è™Ÿ1æ¨“",
    "tax_id": "12345678",
    "payment_terms": "æœˆçµ30å¤©",
    "bank_account": "012-123456789012",
    "bank_name": "å°ç£éŠ€è¡Œ ç‡Ÿæ¥­éƒ¨",
    "notes": "ä¸»è¦ä¾›æ‡‰æš¢éŠ·æ›¸ç±",
    "created_at": "2025-01-15T10:00:00+08:00",
    "updated_at": "2025-07-24T10:00:00+08:00"
  },
  {
    "id": "S002",
    "name": "é‡‘çŸ³å ‚æ–‡å…·æ‰¹ç™¼",
    "contact_person": "æ—å°å§",
    "phone": "02-2369-1234",
    "email": "stationery@kingstone.com.tw",
    "address": "å°åŒ—å¸‚ä¸­æ­£å€é‡æ…¶å—è·¯ä¸€æ®µ119è™Ÿ",
    "tax_id": "23456789",
    "payment_terms": "ç¾é‡‘7å¤©",
    "bank_account": "013-234567890123",
    "bank_name": "åœ‹æ³°ä¸–è¯éŠ€è¡Œ åŸä¸­åˆ†è¡Œ",
    "notes": "æ–‡å…·ç”¨å“æ‰¹ç™¼",
    "created_at": "2025-02-10T09:30:00+08:00",
    "updated_at": "2025-07-24T14:30:00+08:00"
  },
  {
    "id": "S003",
    "name": "èª å“ç²¾å“æ–‡å…·",
    "contact_person": "é™³ç¶“ç†",
    "phone": "02-6639-6888",
    "email": "eslite@eslite.com",
    "address": "å°åŒ—å¸‚ä¿¡ç¾©å€è¸å» è·¯88è™Ÿ",
    "tax_id": "34567890",
    "payment_terms": "æœˆçµ15å¤©",
    "bank_account": "012-345678901234",
    "bank_name": "ä¸­åœ‹ä¿¡è¨— ä¿¡ç¾©åˆ†è¡Œ",
    "notes": "é«˜ç´šæ–‡å…·èˆ‡ç¦®å“",
    "created_at": "2025-03-05T14:20:00+08:00",
    "updated_at": "2025-07-23T09:15:00+08:00"
  },
  {
    "id": "S004",
    "name": "IKEA å•†æ¥­æ¡è³¼",
    "contact_person": "å¼µå°ˆå“¡",
    "phone": "02-412-8869",
    "email": "business@ikea.com.tw",
    "address": "æ–°åŒ—å¸‚æ–°èŠå€ä¸­æ­£è·¯1è™Ÿ",
    "tax_id": "45678901",
    "payment_terms": "æœˆçµ30å¤©",
    "bank_account": "007-456789012345",
    "bank_name": "èŠ±æ——éŠ€è¡Œ å°åŒ—åˆ†è¡Œ",
    "notes": "å‚¢ä¿±èˆ‡æ”¶ç´è§£æ±ºæ–¹æ¡ˆ",
    "created_at": "2025-04-12T11:15:00+08:00",
    "updated_at": "2025-07-22T16:45:00+08:00"
  },
  {
    "id": "S005",
    "name": "åšå®¢ä¾†ç¶“éŠ·ä¸­å¿ƒ",
    "contact_person": "é»ƒç¶“ç†",
    "phone": "02-2653-5588",
    "email": "b2b@books.com.tw",
    "address": "å°åŒ—å¸‚å¤§å®‰å€å…‰å¾©å—è·¯102è™Ÿ3æ¨“",
    "tax_id": "56789012",
    "payment_terms": "æœˆçµ30å¤©",
    "bank_account": "008-567890123456",
    "bank_name": "ç‰å±±éŠ€è¡Œ æ•¦å—åˆ†è¡Œ",
    "notes": "å„é¡æ›¸ç±æ‰¹ç™¼",
    "created_at": "2025-05-20T13:45:00+08:00",
    "updated_at": "2025-07-22T10:30:00+08:00"
  },
  {
    "name": "æ–°å¢",
    "contact_person": "æ–°å¢äºº",
    "phone": "0909090990",
    "email": "service@123",
    "address": "",
    "payment_terms": "æœˆçµ30å¤©",
    "notes": "",
    "id": "S006",
    "created_at": "2025-07-31T13:33:10.751223"
  }
]

===== docs\base.html =====
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ›¸æˆ¿ç®¡ç†ç³»çµ± - æ›¸æˆ¿è¨˜å¸³èˆ‡ç‡Ÿé‹ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <link href="./static/css/styles.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <!-- å°èˆªæ¬„ -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="./index.html" class="text-xl font-bold">ğŸ“š æ›¸æˆ¿ç®¡ç†ç³»çµ±</a>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <a href="./index.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-tachometer-alt mr-1"></i> å„€è¡¨æ¿
                    </a>
                    <a href="./products.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-box mr-1"></i> å•†å“ç®¡ç†
                    </a>
                    <a href="./purchases.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-shopping-cart mr-1"></i> é€²è²¨ç®¡ç†
                    </a>
                    <a href="./sales.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-cash-register mr-1"></i> éŠ·å”®ç®¡ç†
                    </a>
                    <a href="./members.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-users mr-1"></i> æœƒå“¡ç®¡ç†
                    </a>
                    <a href="./suppliers.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-truck mr-1"></i> ä¾›æ‡‰å•†ç®¡ç†
                    </a>
                    <a href="./reports.html" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                        <i class="fas fa-chart-bar mr-1"></i> å ±è¡¨åˆ†æ
                    </a>
                </div>
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-button" class="text-white focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- ç§»å‹•ç«¯èœå–® -->
        <div id="mobile-menu" class="md:hidden hidden pb-4 px-4">
            <a href="./index.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">
                <i class="fas fa-tachometer-alt mr-2"></i> å„€è¡¨æ¿
            </a>
            <a href="./products.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">
                <i class="fas fa-box mr-2"></i> å•†å“ç®¡ç†
            </a>
            <a href="./purchases.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">
                <i class="fas fa-shopping-cart mr-2"></i> é€²è²¨ç®¡ç†
            </a>
            <a href="./sales.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">
                <i class="fas fa-cash-register mr-2"></i> éŠ·å”®ç®¡ç†
            </a>
            <a href="./members.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">
                <i class="fas fa-users mr-2"></i> æœƒå“¡ç®¡ç†
            </a>
            <a href="./suppliers.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">
                <i class="fas fa-truck mr-2"></i> ä¾›æ‡‰å•†ç®¡ç†
            </a>
            <a href="./reports.html" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-blue-700">
                <i class="fas fa-chart-bar mr-2"></i> å ±è¡¨åˆ†æ
            </a>
        </div>
    </nav>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
    </main>

    <!-- é è…³ -->
    <footer class="bg-white mt-12">
        <div class="max-w-7xl mx-auto py-6 px-4 overflow-hidden sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                &copy; 2025 æ›¸æˆ¿è¨˜å¸³èˆ‡ç‡Ÿé‹ç®¡ç†ç³»çµ±. All rights reserved.
            </p>
        </div>
    </footer>

    <!-- å…¨å±€çµ„ä»¶ -->
    <!-- åŠ è¼‰æŒ‡ç¤ºå™¨ -->
<div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <div class="flex items-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <span class="ml-3 text-gray-700">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</span>
        </div>
    </div>
</div>
    <!-- é€šçŸ¥è¨Šæ¯ -->
<div id="notifications" class="fixed top-4 right-4 z-50 space-y-2 w-80">
    <!-- æˆåŠŸé€šçŸ¥ -->
    <div id="success-notification" class="notification hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span class="notification-message">æ“ä½œæˆåŠŸï¼</span>
        </div>
        <button class="absolute top-0 bottom-0 right-0 px-4 py-3 close-notification">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- éŒ¯èª¤é€šçŸ¥ -->
    <div id="error-notification" class="notification hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span class="notification-message">ç™¼ç”ŸéŒ¯èª¤ï¼</span>
        </div>
        <button class="absolute top-0 bottom-0 right-0 px-4 py-3 close-notification">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- è­¦å‘Šé€šçŸ¥ -->
    <div id="warning-notification" class="notification hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative" role="alert">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span class="notification-message">è­¦å‘Šè¨Šæ¯</span>
        </div>
        <button class="absolute top-0 bottom-0 right-0 px-4 py-3 close-notification">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>
    <!-- ç¢ºèªå°è©±æ¡† -->
<div id="confirm-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-96">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900" id="confirm-title">ç¢ºèªæ“ä½œ</h3>
        </div>
        
        <!-- Body -->
        <div class="px-6 py-4">
            <p class="text-gray-600" id="confirm-message">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
        </div>
        
        <!-- Footer -->
        <div class="px-6 py-4 bg-gray-50 text-right rounded-b-lg">
            <button type="button" id="confirm-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                å–æ¶ˆ
            </button>
            <button type="button" id="confirm-ok" class="ml-3 inline-flex justify-center px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                ç¢ºèª
            </button>
        </div>
    </div>
</div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./static/js/ui.js"></script>      
    <script src="./static/js/main.js"></script>    
</body>
</html>